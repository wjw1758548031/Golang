[[customer.financial.list]]
with t as (
SELECT
  c.id,
  c.name,
  sum(o.sale_to_customer_price * o.receive_amount) finish_amt,
  c.contact_name,
  c.contact_phone,
  count(o.id)
FROM t_order o, t_customer c
WHERE o.order_status=5 and o.customer_id = c.id and o.customer_settle_status = ?handle_type
{% if province_id!="" %}
   and c.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
  and c.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
  and c.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
  and c.name ilike '%'|| ?keyword ||'%'
{% endif %}
group by c.id,c.name order by convert_to(c.name,'UTF-8')
)
select x.*,(g.available_quota+COALESCE(g.provisional_quota,0)) available_quota,g.all_quota,COALESCE(g.account_period,0) as account_period from t x left join t_customer_grade g on g.customer_id = x.id limit ?page_size offset (?page_num - 1) * ?page_size

[[customer.financial.all]]
with t as (
SELECT
  c.id,
  c.name,
  sum(o.sale_to_customer_price * o.receive_amount) finish_amt,
  c.contact_name,
  c.contact_phone,
  count(o.id)
FROM t_order o, t_customer c
WHERE o.order_status=5 and o.customer_id = c.id and o.customer_settle_status = ?handle_type
{% if province_id!="" %}
   and c.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
  and c.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
  and c.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
  and c.name ilike '%'|| ?keyword ||'%'
{% endif %}
group by c.id,c.name order by convert_to(c.name,'UTF-8')
)
select x.*,(g.available_quota+COALESCE(g.provisional_quota,0)) available_quota,g.all_quota,COALESCE(g.account_period,0) as account_period from t x left join t_customer_grade g on g.customer_id = x.id

[[customer.financial.cnt]]
with t as (
SELECT
  c.id,
  c.name,
  sum(o.buy_from_supplier_price * o.receive_amount) finish_amt,
  c.contact_name,
  c.contact_phone,
  count(o.id)
FROM t_order o, t_customer c
WHERE o.order_status=5 and o.customer_id = c.id and o.customer_settle_status = ?handle_type
{% if province_id!="" %}
   and c.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
  and c.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
  and c.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
  and c.name ilike '%'|| ?keyword ||'%'
{% endif %}
group by c.id,c.name order by 3
)
select count(1) from t

[[customer.financial.order.cnt]]
SELECT
  count(1)
FROM t_order o, t_customer c
WHERE o.order_status=5 and o.customer_id = c.id and o.customer_settle_status = ?handle_type
{% if province_id!="" %}
   and c.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
  and c.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
  and c.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
  and c.name ilike '%'|| ?keyword ||'%'
{% endif %}


[[customer.financial.detail.list]]
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  g.name goods_name,
  g.unit,
  o.sale_to_customer_price * o.receive_amount sale_to_customer_money,
  o.sale_to_customer_price,
  o.receive_amount,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time,
  o.bill_date,
  (CASE WHEN o.customer_settle_status = 1
    THEN '客户结清'
   ELSE '客户未结' END) ||  ',' ||
  (CASE WHEN o.supplier_settle_status = 1
    THEN '供应商结清'
   ELSE '供应商未结' END) AS   settle_status
FROM t_order o, t_goods g
WHERE o.order_status=5 AND o.goods_id = g.id and o.customer_id = ?id and o.customer_settle_status = ?handle_type
{% if !order_time_start.IsZero %} and o.order_time >= ?order_time_start {% endif %}
{% if !order_time_end.IsZero %} and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !ship_time_start.IsZero %} and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD') {% endif %}
{% if !ship_time_end.IsZero %} and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !finish_time_start.IsZero %} and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD') {% endif %}
{% if !finish_time_end.IsZero %} and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !customer_settle_time_start.IsZero %} and o.customer_settle_time >=to_date(?customer_settle_time_start,'YYYY-MM-DD') {% endif %}
{% if !customer_settle_time_end.IsZero %} and o.customer_settle_time <to_date(?customer_settle_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if settle_status != "" %} and o.supplier_settle_status = ?settle_status {% endif %}
{% if !bill_date_end.IsZero %} and o.bill_date <to_date(?bill_date_end,'YYYY-MM-DD')+1 {% endif %}
{% if !bill_date_start.IsZero %} and o.bill_date >=to_date(?bill_date_start,'YYYY-MM-DD') {% endif %}
ORDER BY o.order_time desc, o.order_no, o.order_sub_no limit ?page_size offset (?page_num - 1) * ?page_size

[[customer.financial.detail.export.list]]
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  g.name goods_name,
  g.unit,
  o.sale_to_customer_price * o.receive_amount sale_to_customer_money,
  o.sale_to_customer_price,
  o.receive_amount,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time,
  o.bill_date,
  (CASE WHEN o.customer_settle_status = 1
    THEN '客户结清'
   ELSE '客户未结' END) ||  ',' ||
  (CASE WHEN o.supplier_settle_status = 1
    THEN '供应商结清'
   ELSE '供应商未结' END) AS   settle_status_desc
FROM t_order o, t_goods g
WHERE o.order_status=5 AND o.goods_id = g.id and o.customer_id = ?id and o.customer_settle_status = ?handle_type
{% if !order_time_start.IsZero %} and o.order_time >= ?order_time_start {% endif %}
{% if !order_time_end.IsZero %} and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !ship_time_start.IsZero %} and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD') {% endif %}
{% if !ship_time_end.IsZero %} and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !finish_time_start.IsZero %} and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD') {% endif %}
{% if !finish_time_end.IsZero %} and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !customer_settle_time_start.IsZero %} and o.customer_settle_time >=to_date(?customer_settle_time_start,'YYYY-MM-DD') {% endif %}
{% if !customer_settle_time_end.IsZero %} and o.customer_settle_time <to_date(?customer_settle_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if settle_status != "" %} and o.supplier_settle_status = ?settle_status {% endif %}
{% if !bill_date_end.IsZero %} and o.bill_date <to_date(?bill_date_end,'YYYY-MM-DD')+1 {% endif %}
{% if !bill_date_start.IsZero %} and o.bill_date >=to_date(?bill_date_start,'YYYY-MM-DD') {% endif %}
ORDER BY o.order_time desc, o.order_no, o.order_sub_no

[[customer.financial.detail.cnt]]
SELECT
  count(1)
FROM t_order o, t_goods g
WHERE o.order_status=5 AND o.goods_id = g.id and o.customer_id = ?id and o.customer_settle_status = ?handle_type
{% if !order_time_start.IsZero %} and o.order_time >= ?order_time_start {% endif %}
{% if !order_time_end.IsZero %} and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !ship_time_start.IsZero %} and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD') {% endif %}
{% if !ship_time_end.IsZero %} and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !finish_time_start.IsZero %} and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD') {% endif %}
{% if !finish_time_end.IsZero %} and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if !customer_settle_time_start.IsZero %} and o.customer_settle_time >=to_date(?customer_settle_time_start,'YYYY-MM-DD') {% endif %}
{% if !customer_settle_time_end.IsZero %} and o.customer_settle_time <to_date(?customer_settle_time_end,'YYYY-MM-DD')+1 {% endif %}
{% if settle_status != "" %} and o.supplier_settle_status = ?settle_status {% endif %}
{% if !bill_date_end.IsZero %} and o.bill_date <to_date(?bill_date_end,'YYYY-MM-DD')+1 {% endif %}
{% if !bill_date_start.IsZero %} and o.bill_date >=to_date(?bill_date_start,'YYYY-MM-DD') {% endif %}


[[supplier.financial.list]]
with t as (
SELECT
  s.id,
  s.name,
  sum(o.buy_from_supplier_price * o.receive_amount) finish_amt,
  s.contact_name,
  s.contact_phone,
  count(o.id)
FROM t_order o, t_supplier s
WHERE o.order_status=5 and o.supplier_id = s.id and o.supplier_settle_status = ?handle_type
{% if province_id!="" %}
   and s.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
  and  s.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
  and  s.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
  and  s.name ilike '%'|| ?keyword ||'%'
{% endif %}
group by s.id,s.name order by convert_to(s.name,'UTF-8')
)
select * from t limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.financial.export.list]]
with t as (
SELECT
  s.id,
  s.name,
  sum(o.buy_from_supplier_price * o.receive_amount) finish_amt,
  s.contact_name,
  s.contact_phone,
  count(o.id)
FROM t_order o, t_supplier s
WHERE o.order_status=5 and o.supplier_id = s.id and o.supplier_settle_status = ?handle_type
{% if province_id!="" %}
   and s.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
  and  s.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
  and  s.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
  and  s.name ilike '%'|| ?keyword ||'%'
{% endif %}
group by s.id,s.name order by convert_to(s.name,'UTF-8')
)
select * from t

[[supplier.financial.cnt]]
with t as (
SELECT
  s.id,
  s.name,
  sum(o.buy_from_supplier_price * o.receive_amount) finish_amt,
  s.contact_name,
  s.contact_phone,
  count(o.id)
FROM t_order o, t_supplier s
WHERE o.order_status=5 and o.supplier_id = s.id and o.supplier_settle_status = ?handle_type
{% if province_id!="" %}
   and s.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
  and  s.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
  and  s.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
  and  s.name ilike '%'|| ?keyword ||'%'
{% endif %}
group by s.id,s.name order by 3
)
select count(1) from t

[[supplier.financial.order.cnt]]
SELECT
  count(1)
FROM t_order o, t_supplier s
WHERE o.order_status=5 and o.supplier_id = s.id and o.supplier_settle_status = ?handle_type
{% if province_id!="" %}
   and s.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
  and  s.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
  and  s.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
  and  s.name ilike '%'|| ?keyword ||'%'
{% endif %}

[[supplier.financial.detail.list]]
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  g.name goods_name,
  g.unit,
  o.buy_from_supplier_price * o.receive_amount sale_to_customer_money,
  o.buy_from_supplier_price,
  o.receive_amount,
  o.w_receive_amount,
  o.s_receive_amount,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time,
  o.supplier_settle_time,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已收款'
       WHEN o.supplier_settle_status = 2 THEN '中心未打款'
       ELSE '中心已打款' END supplier_settle_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '中心已收款'
       WHEN o.customer_settle_status = 2 THEN '客户未打款'
       ELSE '客户已打款' END customer_settle_status_desc,
  o.customer_settle_status,
  o.supplier_settle_status,
  o.order_sign_time,
  o.order_status,
  c.name customer_name
FROM t_order o, t_goods g, t_customer c
WHERE o.goods_id = g.id and o.customer_id = c.id and o.supplier_id = ?id and o.bill_time = ?bill_time
{% if customer_id != "" %}
and o.customer_id =?customer_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
 {% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !supplier_settle_time_start.IsZero %}
and o.supplier_settle_time >=to_date(?supplier_settle_time_start,'YYYY-MM-DD')
{% endif %}
{% if !supplier_settle_time_end.IsZero %}
and o.supplier_settle_time <to_date(?supplier_settle_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.supplier_settle_status = ?settle_status
{% endif %}
ORDER BY o.order_time desc,o.order_no, o.order_sub_no limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.financial.detail.list.export]]
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  g.name goods_name,
  g.unit,
  o.buy_from_supplier_price * o.receive_amount sale_to_customer_money,
  o.buy_from_supplier_price,
  o.receive_amount,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time,
  o.supplier_settle_time,
  o.order_sign_time,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已收款'
       WHEN o.supplier_settle_status = 2 THEN '中心未打款'
       ELSE '中心已打款' END supplier_settle_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '中心已收款'
       WHEN o.customer_settle_status = 2 THEN '客户未打款'
       ELSE '客户已打款' END customer_settle_status_desc,
  o.customer_settle_status,
  o.supplier_settle_status,
  o.order_sign_time,
  o.order_status,
  c.name customer_name
FROM t_order o, t_goods g, t_customer c
WHERE o.goods_id = g.id and o.customer_id = c.id and o.supplier_id = ?id and o.bill_time = ?bill_time
{% if customer_id != "" %}
and o.customer_id =?customer_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
 {% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !supplier_settle_time_start.IsZero %}
and o.supplier_settle_time >=to_date(?supplier_settle_time_start,'YYYY-MM-DD')
{% endif %}
{% if !supplier_settle_time_end.IsZero %}
and o.supplier_settle_time <to_date(?supplier_settle_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.supplier_settle_status = ?settle_status
{% endif %}
ORDER BY o.order_time desc,o.order_no, o.order_sub_no

[[supplier.financial.detail.cnt]]
SELECT
  count(1)
FROM t_order o, t_goods g, t_customer c
WHERE o.goods_id = g.id and o.customer_id = c.id and o.supplier_id = ?id and o.bill_time = ?bill_time
{% if customer_id != "" %}
and o.customer_id =?customer_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
 {% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !supplier_settle_time_start.IsZero %}
and o.supplier_settle_time >=to_date(?supplier_settle_time_start,'YYYY-MM-DD')
{% endif %}
{% if !supplier_settle_time_end.IsZero %}
and o.supplier_settle_time <to_date(?supplier_settle_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.supplier_settle_status = ?settle_status
{% endif %}

[[platform.financial.cnt]]
select count(1) cnt from t_order o where o.supplier_id = ?supplier_id and o.bill_time = ?bill_time
{% if customer_id!="" %}
and o.customer_id=?customer_id
{% endif %}
{% if handle_type!=0 %}
and o.supplier_settle_status=?handle_type
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !customer_settle_time_start.IsZero %}
and o.customer_settle_time >=to_date(?customer_settle_time_start,'YYYY-MM-DD')
{% endif %}
{% if !customer_settle_time_end.IsZero %}
and o.customer_settle_time <to_date(?customer_settle_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}

[[platform.financial.list]]
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  o.unit,
  o.receive_amount * o.buy_from_supplier_price total_money,
  CASE WHEN o.supplier_settle_status = 1
    THEN '已结单'
  ELSE '未结单' END                            status_desc,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.supplier_settle_time                      settle_time,
  o.receive_amount,
  o.w_receive_amount,
  o.s_receive_amount,
  o.buy_from_supplier_price,
  o.order_sign_time,
  c.name customer_name,
  o.order_status,
  o.supplier_settle_status,
  o.customer_settle_status,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已收款'
       WHEN o.supplier_settle_status = 2 THEN '中心未打款'
       ELSE '中心已打款' END supplier_settle_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '中心已收款'
       WHEN o.customer_settle_status = 2 THEN '客户未打款'
  ELSE '客户已打款' END customer_settle_status_desc
 from t_order o,t_customer c
 where o.customer_id = c.id and o.supplier_id = ?supplier_id and o.bill_time = ?bill_time
{% if customer_id!="" %}
and o.customer_id=?customer_id
{% endif %}
{% if handle_type!=0 %}
and o.supplier_settle_status=?handle_type
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !customer_settle_time_start.IsZero %}
and o.supplier_settle_time >=to_date(?customer_settle_time_start,'YYYY-MM-DD')
{% endif %}
{% if !customer_settle_time_end.IsZero %}
and o.supplier_settle_time <to_date(?customer_settle_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
order by o.create_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[platform.check.bill.order.cnt]]
select count(1) cnt from t_order o where o.supplier_id = ?supplier_id and o.supplier_check_bill_time = ?bill_time
{% if customer_id!="" %}
and o.customer_id=?customer_id
{% endif %}
{% if handle_type!=0 %}
and o.supplier_check_status=?handle_type
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}

[[platform.check.bill.order.list]]
SELECT
  o.*,
  o.w_receive_amount * o.buy_from_supplier_price w_receive_total_amount,
  o.receive_amount * o.buy_from_supplier_price total_money,
  CASE WHEN o.supplier_settle_status = 1
    THEN '已结单'
  ELSE '未结单' END                            status_desc,
  o.supplier_settle_time                      settle_time,
  c.name customer_name,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已收款'
       WHEN o.supplier_settle_status = 2 THEN '中心未打款'
       ELSE '中心已打款' END supplier_settle_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '中心已收款'
       WHEN o.customer_settle_status = 2 THEN '客户未打款'
       ELSE '客户已打款' END customer_settle_status_desc,
  CASE WHEN o.supplier_check_status = 1 THEN '供应商已对账'
       WHEN o.supplier_settle_status = 2 THEN '供应商未对账'
       ELSE '未知' END supplier_check_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '客户已对账'
       WHEN o.customer_settle_status = 2 THEN '客户未对账'
  ELSE '未知' END customer_check_status_desc
 from t_order o,t_customer c
 where o.customer_id = c.id and o.supplier_id = ?supplier_id and o.supplier_check_bill_time = ?bill_time
{% if customer_id!="" %}
and o.customer_id=?customer_id
{% endif %}
{% if handle_type!=0 %}
and o.supplier_check_status=?handle_type
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
order by o.create_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[platform.financial.list.export]]
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  o.unit,
  o.receive_amount * o.buy_from_supplier_price total_money,
  CASE WHEN o.supplier_settle_status = 1
    THEN '已结单'
  ELSE '未结单' END                            status_desc,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.supplier_settle_time                      settle_time,
  o.receive_amount,
  o.buy_from_supplier_price,
  o.order_sign_time,
  c.name customer_name,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已收款'
       WHEN o.supplier_settle_status = 2 THEN '中心未打款'
       ELSE '中心已打款' END supplier_settle_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '中心已收款'
       WHEN o.customer_settle_status = 2 THEN '客户未打款'
  ELSE '客户已打款' END customer_settle_status_desc
 from t_order o,t_customer c
 where o.customer_id = c.id and o.supplier_id = ?supplier_id and o.bill_time = ?bill_time
{% if customer_id!="" %}
and o.customer_id=?customer_id
{% endif %}
{% if handle_type!=0 %}
and o.supplier_settle_status=?handle_type
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !customer_settle_time_start.IsZero %}
and o.supplier_settle_time >=to_date(?customer_settle_time_start,'YYYY-MM-DD')
{% endif %}
{% if !customer_settle_time_end.IsZero %}
and o.supplier_settle_time <to_date(?customer_settle_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
order by o.create_time desc

[[warehouse.financial.cnt]]
select count(1) cnt from t_warehouse tw where tw.status != 3 and tw.supplier_id=?supplier_id
{% if province_id!="" %}
and tw.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
and tw.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
and tw.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
and  (CnFirstChar(tw.name) ilike '%'||?keyword||'%' or tw.name ilike '%'||?keyword||'%')
{% endif %}

[[warehouse.financial.list]]
with tmp as (
SELECT
  tw.id  warehouse_id,
  tw.name,
  tw.contact_name,
  tw.contact_phone
FROM t_warehouse tw
WHERE tw.status != 3 and tw.supplier_id=?supplier_id
{% if province_id!="" %}
and tw.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
and tw.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
and tw.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
and (CnFirstChar(tw.name) ilike '%'||?keyword||'%' or tw.name ilike '%'||?keyword||'%' )
{% endif %}
order by convert_to(tw.name,'UTF-8')
limit ?page_size offset (?page_num - 1) * ?page_size
)
select tmp.*,(SELECT sum(o.receive_amount * o.buy_from_supplier_price)  FROM t_order o
   WHERE o.order_status=5  AND o.warehouse_id = tmp.warehouse_id) finish_total_money
from tmp order by convert_to(tmp.name,'UTF-8')

[[warehouse.financial.exportList]]
with tmp as (
SELECT
  tw.id  warehouse_id,
  tw.name,
  tw.contact_name,
  tw.contact_phone
FROM t_warehouse tw
WHERE tw.status != 3 and tw.supplier_id=?supplier_id
{% if province_id!="" %}
and tw.province_id = ?province_id
{% endif %}
{% if city_id!="" %}
and tw.city_id = ?city_id
{% endif %}
{% if district_id!="" %}
and tw.district_id = ?district_id
{% endif %}
{% if keyword!="" %}
and tw.name ilike '%'||?keyword||'%'
{% endif %}
order by convert_to(tw.name,'UTF-8')
)
select tmp.*,(SELECT sum(o.receive_amount * o.buy_from_supplier_price)  FROM t_order o
   WHERE o.order_status=5  AND o.warehouse_id = tmp.warehouse_id) finish_total_money
from tmp order by convert_to(tmp.name,'UTF-8')

[[warehouse.detail.financial.cnt]]
select count(1) cnt from t_order o where o.order_status=9
{% if warehouse_id!="" %}
and dispatch_type=2
and o.warehouse_id=?warehouse_id
{% endif %}
{% if supplier_id!="" %}
and dispatch_type=1
and o.supplier_id=?supplier_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}

[[warehouse.detail.financial.list]]
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  o.unit,
  o.receive_amount,
  o.s_receive_amount,
  o.w_receive_amount,
  o.order_status,
  CASE WHEN o.receive_time > coalesce(o.verify_time,'0001-01-01') THEN
            CASE WHEN o.receive_time > coalesce(o.order_w_sign_time,'0001-01-01') THEN 3 ELSE 1 END
         ELSE
           CASE WHEN coalesce(o.verify_time,'0001-01-01')  > coalesce(o.order_w_sign_time,'0001-01-01') THEN 2 ELSE 1 END
        END time_ordering,
  o.receive_amount * o.buy_from_supplier_price real_total_money,
  order_time,
  o.ship_time,
  o.finish_time,
  o.buy_from_supplier_price
FROM t_order o where o.order_status=9
{% if warehouse_id!="" %}
and dispatch_type=2
and o.warehouse_id=?warehouse_id
{% endif %}
{% if supplier_id!="" %}
and dispatch_type=1
and o.supplier_id=?supplier_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !reportTemp %}
limit ?page_size offset (?page_num - 1) * ?page_size
{% endif %}

[[website.financial.cnt]]
SELECT
  count(1)
FROM t_order o
left join t_goods g on o.goods_id = g.id
where o.order_status=5 and o.customer_id=?customer_id
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}

[[website.financial.list]]
SELECT
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  g.unit,
  o.receive_amount,
  o.sale_to_customer_price,
  o.sale_to_customer_price * o.receive_amount finish_amt,
  (CASE WHEN o.customer_settle_status = 1
    THEN '已结单'
   WHEN o.customer_settle_status = 2
     THEN '未结单' END) status_desc,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time
FROM t_order o
left join t_goods g on o.goods_id = g.id
where o.order_status=5 and o.customer_id=?customer_id
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}
order by o.order_time desc,o.order_no,o.order_sub_no
limit ?page_size offset (?page_num - 1) * ?page_size

[[website.financial.export.list]]
SELECT
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  g.unit,
  o.receive_amount,
  o.sale_to_customer_price,
  o.sale_to_customer_price * o.receive_amount finish_amt,
  (CASE WHEN o.customer_settle_status = 1
    THEN '已结单'
   WHEN o.customer_settle_status = 2
     THEN '未结单' END) status_desc,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time
FROM t_order o
left join t_goods g on o.goods_id = g.id
where o.order_status=5 and o.customer_id=?customer_id
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}
order by o.order_time desc,o.order_no,o.order_sub_no

[[jt.financial.list]]
with temp as (
SELECT
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  g.unit,
  o.receive_amount,
  o.sale_to_customer_price,
  o.sale_to_customer_price * o.receive_amount finish_amt,
  (CASE WHEN o.customer_settle_status = 1
    THEN '已结单'
   WHEN o.customer_settle_status = 2
     THEN '未结单' END) status_desc,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time,
  o.customer_id
FROM t_order o
left join t_goods g on o.goods_id = g.id
where o.order_status=5
and o.customer_id in (select id from t_customer where parent_customer_id =?parent_customer_id )
and o.customer_id in (select customer_id from t_account_child_customer where account_id =?account_id )
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}
order by o.order_time desc,o.order_no,o.order_sub_no
limit ?page_size offset (?page_num - 1) * ?page_size
)
select temp.*,cus.name customer_name from temp left join t_customer cus on cus.id = temp.customer_id

[[jt.financial.cnt]]
SELECT
  count(1)
FROM t_order o
left join t_goods g on o.goods_id = g.id
where o.order_status=5
and o.customer_id in (select id from t_customer where parent_customer_id =?parent_customer_id )
and o.customer_id in (select customer_id from t_account_child_customer where account_id =?account_id )
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}

[[jt.financial.export.list]]
with temp as (
SELECT
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  g.unit,
  o.receive_amount,
  o.sale_to_customer_price,
  o.sale_to_customer_price * o.receive_amount finish_amt,
  (CASE WHEN o.customer_settle_status = 1
    THEN '已结单'
   WHEN o.customer_settle_status = 2
     THEN '未结单' END) status_desc,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time,
  o.customer_id
FROM t_order o
left join t_goods g on o.goods_id = g.id
where o.order_status=5
and o.customer_id in (select id from t_customer where parent_customer_id =?parent_customer_id )
and o.customer_id in (select customer_id from t_account_child_customer where account_id =?account_id )
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}
order by o.order_time desc,o.order_no,o.order_sub_no
)
select temp.*,cus.name customer_name from temp left join t_customer cus on cus.id = temp.customer_id

[[financial.customer.cnt]]
select count(1)
from t_customer c , t_province p ,t_city q , t_district d where
c.parent_customer_id = ?parent_customer_id and
c.province_id = p.id and c.city_id = q.id and c.district_id = d.id
{% if province_id != "" %}
    and c.province_id = ?province_id
{% endif %}
{% if city_id != "" %}
    and c.city_id = ?city_id
{% endif %}
{% if district_id != "" %}
    and c.district_id = ?district_id
{% endif %}
{% if keyword != "" %}
    and c.name ilike '%'|| ?keyword ||'%'
{% endif %}

[[financial.customer.list]]
with temp as (
    select c.* from t_customer c , t_province p ,t_city q , t_district d where
    c.parent_customer_id = ?parent_customer_id and
    c.province_id = p.id and c.city_id = q.id and c.district_id = d.id
    {% if province_id != "" %}
       and c.province_id = ?province_id
    {% endif %}
    {% if city_id != "" %}
       and c.city_id = ?city_id
    {% endif %}
    {% if district_id != "" %}
       and c.district_id = ?district_id
    {% endif %}
    {% if keyword != "" %}
       and c.name ilike '%'|| ?keyword ||'%'
    {% endif %}
)
select
    t.id customer_id,
    t.name customer_name,
    t.contact_name,
    t.contact_phone,
    cg.account_period,
    COALESCE(cg.all_quota,0) all_quota,
    COALESCE(cg.available_quota+cg.provisional_quota,0) total_quota,
    o1.finish_amount,
    o3.ready_pay_count,
    o3.ready_pay_amount
from temp t
left join t_customer_grade cg on t.id = cg.customer_id
left join (
    select sum(COALESCE(sale_to_customer_price,0) * COALESCE(receive_amount,0)) finish_amount,customer_id
    from t_order
    where customer_id in (select customer_id from temp) and order_status = 12
    group by customer_id
) o1 on o1.customer_id = t.id
left join (
    select count(*) ready_pay_count,sum(COALESCE(sale_to_customer_price,0) * COALESCE(receive_amount,0)) ready_pay_amount,customer_id
    from t_order
    where customer_id in (select customer_id from temp) and order_status = 12
    and (customer_settle_status = 2 or customer_settle_status = 3)
    group by customer_id
) o3 on o3.customer_id = t.id
order by t.id desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[financial.supplier.cnt]]
select count(1)
from t_supplier a ,t_account b,t_role r,t_acct_role ar
where a.id = b.supplier_id and b.id=ar.account_id and r.id=ar.role_id and r.role_code = 'spl_admin' and b.account_type = 2
{% if province_id != "" %}
    and a.province_id = ?province_id
{% endif %}
{% if city_id != "" %}
    and a.city_id = ?city_id
{% endif %}
{% if district_id != "" %}
   and a.district_id = ?district_id
{% endif %}
{% if keyword != "" %}
   and (a.name ilike '%'|| ?keyword ||'%' or b.login_name ilike '%'|| ?keyword ||'%')
{% endif %}

[[financial.supplier.list]]
with tem as (
    select a.* from t_supplier a ,t_account b,t_role r,t_acct_role ar
    where a.id = b.supplier_id and b.id=ar.account_id and r.id=ar.role_id and r.role_code = 'spl_admin' and b.account_type = 2
    {% if province_id != "" %}
       and a.province_id = ?province_id
    {% endif %}
    {% if city_id != "" %}
       and a.city_id = ?city_id
    {% endif %}
    {% if district_id != "" %}
       and a.district_id = ?district_id
    {% endif %}
    {% if keyword != "" %}
       and (a.name ilike '%'|| ?keyword ||'%' or b.login_name ilike '%'|| ?keyword ||'%')
    {% endif %}
)
select
    t.id supplier_id,
    t.name supplier_name,
    t.contact_name,
    t.contact_phone,
    o1.finish_amount,
    o2.collect_count,
    o2.ready_pay_amount
from tem t
left join (
    select sum(COALESCE(o.buy_from_supplier_price,0) * COALESCE(o.receive_amount,0)) finish_amount,o.supplier_id
    from t_order o where o.order_status = 12
    and (o.supplier_settle_status = 1 or o.supplier_settle_status = 3)
    group by o.supplier_id
) o1 on o1.supplier_id = t.id
left join (
    select count(*) collect_count,o.supplier_id,sum(COALESCE(o.buy_from_supplier_price,0) * COALESCE(o.receive_amount,0)) ready_pay_amount
    from t_order o where o.order_status = 12 and o.supplier_settle_status = 2  group by o.supplier_id
) o2 on o2.supplier_id = t.id
order by t.id desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[jt.financial.customer.cnt]]
select count(1)
from t_customer c , t_province p ,t_city q , t_district d where c.id in (
    select acc.customer_id from t_account_child_customer acc
    where account_id = ?account_id
) and c.province_id = p.id and c.city_id = q.id and c.district_id = d.id
{% if province_id != "" %}
    and c.province_id = ?province_id
{% endif %}
{% if city_id != "" %}
    and c.city_id = ?city_id
{% endif %}
{% if district_id != "" %}
    and c.district_id = ?district_id
{% endif %}
{% if keyword != "" %}
    and c.name ilike '%'|| ?keyword ||'%'
{% endif %}

[[jt.financial.customer.list]]
with temp as (
    select c.* from t_customer c , t_province p ,t_city q , t_district d where c.id in (
        select acc.customer_id from t_account_child_customer acc
        where account_id = ?account_id
    ) and c.province_id = p.id and c.city_id = q.id and c.district_id = d.id
    {% if province_id != "" %}
       and c.province_id = ?province_id
    {% endif %}
    {% if city_id != "" %}
       and c.city_id = ?city_id
    {% endif %}
    {% if district_id != "" %}
       and c.district_id = ?district_id
    {% endif %}
    {% if keyword != "" %}
       and c.name ilike '%'|| ?keyword ||'%'
    {% endif %}
)
select
    t.id customer_id,
    t.name customer_name,
    t.contact_name,
    t.contact_phone,
    cg.account_period,
    COALESCE(cg.all_quota,0) all_quota,
    COALESCE(cg.available_quota+cg.provisional_quota,0) total_quota,
    o1.finish_amount,
    o3.ready_pay_count,
    o3.ready_pay_amount
from temp t
left join t_customer_grade cg on t.id = cg.customer_id
left join (
    select sum(COALESCE(sale_to_customer_price,0) * COALESCE(receive_amount,0)) finish_amount,customer_id
    from t_order
    where customer_id in (select customer_id from temp) and order_status = 12
    group by customer_id
) o1 on o1.customer_id = t.id
left join (
    select count(*) ready_pay_count ,sum(COALESCE(sale_to_customer_price,0) * COALESCE(receive_amount,0)) ready_pay_amount,customer_id
    from t_order
    where customer_id in (select customer_id from temp) and order_status = 12 and customer_settle_status = 2
    group by customer_id
) o3 on o3.customer_id = t.id
order by t.id desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[jt.financial.customer.list.export]]
with temp as (
    select c.* from t_customer c , t_province p ,t_city q , t_district d where c.id in (
        select acc.customer_id from t_account_child_customer acc
        where account_id = ?account_id
    ) and c.province_id = p.id and c.city_id = q.id and c.district_id = d.id
    {% if province_id != "" %}
       and c.province_id = ?province_id
    {% endif %}
    {% if city_id != "" %}
       and c.city_id = ?city_id
    {% endif %}
    {% if district_id != "" %}
       and c.district_id = ?district_id
    {% endif %}
    {% if keyword != "" %}
       and c.name ilike '%'|| ?keyword ||'%'
    {% endif %}
)
select
    t.id customer_id,
    t.name customer_name,
    t.contact_name,
    t.contact_phone,
    cg.account_period,
    COALESCE(cg.all_quota,0) all_quota,
    COALESCE(cg.available_quota+cg.provisional_quota,0) total_quota,
    o1.finish_amount,
    o3.ready_pay_count,
    o3.ready_pay_amount
from temp t
left join t_customer_grade cg on t.id = cg.customer_id
left join (
    select sum(COALESCE(sale_to_customer_price,0) * COALESCE(receive_amount,0)) finish_amount,customer_id
    from t_order
    where customer_id in (select customer_id from temp) and order_status = 12
    group by customer_id
) o1 on o1.customer_id = t.id
left join (
    select count(*) ready_pay_count,sum(COALESCE(sale_to_customer_price,0) * COALESCE(receive_amount,0)) ready_pay_amount,customer_id
    from t_order
    where customer_id in (select customer_id from temp) and order_status = 12 and customer_settle_status = 2
    group by customer_id
) o3 on o3.customer_id = t.id
order by t.id desc

[[jt.financial.bill.time.list]]
select bill_time
from t_order where bill_time is not null and customer_id = ?customer_id group by bill_time

[[jt.financial.check.bill.time.list]]
select DISTINCT o.bill_time
from t_order o
where exists (
   select * from t_customer cs
   inner join (
      select * from t_account_child_customer where account_id = ?account_id
   )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
            or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
   where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
)
and o.bill_time is not null and o.bill_time!=''
order by o.bill_time desc

[[supplier.financial.bill.time.list]]
select bill_time
from t_order where bill_time is not null and supplier_id = ?supplier_id group by bill_time

[[supplier.check.bill.time.list]]
select supplier_check_bill_time check_bill_time
from t_order_check_bill ocb
  left join t_order o on ocb.order_id = o.id
where o.supplier_id = ?supplier_id
and supplier_check_bill_time != ''
group by ocb.supplier_check_bill_time order by supplier_check_bill_time desc

[[supplier.check.bill.pcust.list]]
select DISTINCT pc.id customer_id ,pc.name customer_name
from t_order_check_bill ocb
  left join t_order o on ocb.order_id = o.id
  left join t_customer c on o.customer_id = c.id
  left join t_customer pc on c.parent_customer_id = pc.id
where pc.id is not null
and o.supplier_id = ?supplier_id

[[jt.financial.bill.cnt]]
select count(1) from (
    select bill_time
    from t_order where bill_time is not null and customer_id = ?customer_id
    {% if bill_time != "" %}
       and bill_time = ?bill_time
    {% endif %}
     group by bill_time
) a

[[jt.financial.bill.list]]
with tem as (
    select bill_time
    from t_order where bill_time is not null and customer_id = ?customer_id
    {% if bill_time != "" %}
       and bill_time = ?bill_time
    {% endif %}
    group by bill_time
)
select
    ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
    t.bill_time,
    o1.customer_settle_count,
    o1.customer_settle_amount,
    o5.pay_amount,
    o2.goods_count,
    o3.supplier_count,
    o4.order_count
from tem t
left join (
    select bill_time,count(*) customer_settle_count,sum(sale_to_customer_price * receive_amount) customer_settle_amount
    from t_order
    where bill_time in (select bill_time from tem)
    {% if is_admin == 1  %}
        and customer_settle_status = 1
    {% else %}
        and (customer_settle_status = 1 or customer_settle_status = 3)
    {% endif%}
    and customer_id = ?customer_id
    group by bill_time
) o1 on t.bill_time = o1.bill_time
left join (
    select bill_time,sum(receive_amount) goods_count
    from t_order where bill_time in (select bill_time from tem) and customer_id = ?customer_id
    group by bill_time
) o2 on t.bill_time = o2.bill_time
left join (
    select count(c.*) supplier_count,c.bill_time from (
        select supplier_id,bill_time
        from t_order
        where bill_time in (select bill_time from tem) and customer_id = ?customer_id
        group by bill_time,supplier_id
    ) c group by bill_time
) o3 on t.bill_time = o3.bill_time
left join (
    select bill_time,count(*) order_count
    from t_order where bill_time in (select bill_time from tem) and customer_id = ?customer_id
    group by bill_time
) o4 on t.bill_time = o4.bill_time
left join (
    select bill_time,sum(sale_to_customer_price * receive_amount) pay_amount
    from t_order
    where bill_time in (select bill_time from tem)
    {% if is_admin == 1  %}
        and (customer_settle_status = 2 or customer_settle_status = 3)
    {% else %}
        and customer_settle_status = 2
    {% endif%}
    and customer_id = ?customer_id
    group by bill_time
) o5 on t.bill_time = o5.bill_time
order by t.bill_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[jt.financial.check.bill.cnt]]
select count(1) from (
    select customer_check_bill_time
    from t_order where customer_check_bill_time is not null and customer_id = ?customer_id
    {% if bill_time != "" %}
       and customer_check_bill_time = ?bill_time
    {% endif %}
     group by customer_check_bill_time
) a

[[jt.financial.check.bill.list]]
with tem as (
    select customer_check_bill_time
    from t_order where customer_check_bill_time is not null and customer_id = ?customer_id
    {% if bill_time != "" %}
       and customer_check_bill_time = ?bill_time
    {% endif %}
    group by customer_check_bill_time
)
select
    ROW_NUMBER () OVER (ORDER BY t.customer_check_bill_time desc) AS row_num,
    t.customer_check_bill_time,
    o1.customer_checked_count,
    o1.customer_checked_amount,
    o5.check_amount,
    o2.goods_count,
    o3.supplier_count,
    o4.order_count
from tem t
left join (
    select customer_check_bill_time,count(*) customer_checked_count,sum(sale_to_customer_price * receive_amount) customer_checked_amount
    from t_order
    where customer_check_bill_time in (select customer_check_bill_time from tem)
    and customer_check_status = 1
    and customer_id = ?customer_id
    group by customer_check_bill_time
) o1 on t.customer_check_bill_time = o1.customer_check_bill_time
left join (
    select customer_check_bill_time,sum(receive_amount) goods_count
    from t_order where customer_check_bill_time in (select customer_check_bill_time from tem) and customer_id = ?customer_id
    group by customer_check_bill_time
) o2 on t.customer_check_bill_time = o2.customer_check_bill_time
left join (
    select count(c.*) supplier_count,c.customer_check_bill_time from (
        select supplier_id,customer_check_bill_time
        from t_order
        where customer_check_bill_time in (select customer_check_bill_time from tem) and customer_id = ?customer_id
        group by customer_check_bill_time,supplier_id
    ) c group by customer_check_bill_time
) o3 on t.customer_check_bill_time = o3.customer_check_bill_time
left join (
    select customer_check_bill_time,count(*) order_count
    from t_order where customer_check_bill_time in (select customer_check_bill_time from tem) and customer_id = ?customer_id
    group by customer_check_bill_time
) o4 on t.customer_check_bill_time = o4.customer_check_bill_time
left join (
    select customer_check_bill_time,sum(sale_to_customer_price * receive_amount) check_amount
    from t_order
    where customer_check_bill_time in (select customer_check_bill_time from tem)
    and customer_settle_status = 2
    and customer_id = ?customer_id
    group by customer_check_bill_time
) o5 on t.customer_check_bill_time = o5.customer_check_bill_time
order by t.customer_check_bill_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[jt.financial.bill.list.export]]
with tem as (
    select bill_time
    from t_order where bill_time is not null and customer_id = ?customer_id
    {% if bill_time != "" %}
       and bill_time = ?bill_time
    {% endif %}
    group by bill_time
)
select
    ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
    t.bill_time,
    o1.customer_settle_count,
    o1.customer_settle_amount,
    o5.pay_amount,
    o2.goods_count,
    o3.supplier_count,
    o4.order_count
from tem t
left join (
    select bill_time,count(*) customer_settle_count,sum(sale_to_customer_price * receive_amount) customer_settle_amount
    from t_order
    where bill_time in (select bill_time from tem)
    {% if is_admin == 1  %}
        and customer_settle_status = 1
    {% else %}
        and (customer_settle_status = 1 or customer_settle_status = 3)
    {% endif%}
    and customer_id = ?customer_id
    group by bill_time
) o1 on t.bill_time = o1.bill_time
left join (
    select bill_time,sum(receive_amount) goods_count
    from t_order where bill_time in (select bill_time from tem) and customer_id = ?customer_id
    group by bill_time
) o2 on t.bill_time = o2.bill_time
left join (
    select count(c.*) supplier_count,c.bill_time from (
        select supplier_id,bill_time
        from t_order
        where bill_time in (select bill_time from tem) and customer_id = ?customer_id
        group by bill_time,supplier_id
    ) c group by bill_time
) o3 on t.bill_time = o3.bill_time
left join (
    select bill_time,count(*) order_count
    from t_order where bill_time in (select bill_time from tem) and customer_id = ?customer_id
    group by bill_time
) o4 on t.bill_time = o4.bill_time
left join (
    select bill_time,sum(sale_to_customer_price * receive_amount) pay_amount
    from t_order
    where bill_time in (select bill_time from tem)
    {% if is_admin == 1  %}
        and (customer_settle_status = 2 or customer_settle_status = 3)
    {% else %}
        and customer_settle_status = 2
    {% endif%}
    and customer_id = ?customer_id
    group by bill_time
) o5 on t.bill_time = o5.bill_time
order by t.bill_time desc

[[supplier.financial.bill.cnt]]
select count(1) from (
    select bill_time
    from t_order where bill_time is not null and supplier_id = ?supplier_id
    {% if bill_time != "" %}
       and bill_time = ?bill_time
    {% endif %}
     group by bill_time
) a

[[supplier.financial.bill.list]]
with tem as (
    select bill_time
    from t_order where bill_time is not null and supplier_id = ?supplier_id
    {% if bill_time != "" %}
       and bill_time = ?bill_time
    {% endif %}
    group by bill_time
)
select
    ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
    t.bill_time,
    o1.supplier_settle_count,
    o1.receive_amount,
    o3.not_receive_amount,
    o2.goods_count,
    o4.order_count,
    o5.customer_count
from tem t
left join (
    select bill_time,count(*) supplier_settle_count,sum(COALESCE(receive_amount,0) * COALESCE(buy_from_supplier_price,0)) receive_amount
    from t_order
    where bill_time in (select bill_time from tem)
    {% if is_admin == 1  %}
        and (supplier_settle_status = 1 or supplier_settle_status = 3)
    {% else %}
        and supplier_settle_status = 1
    {% endif%}
    and supplier_id = ?supplier_id
    group by bill_time
) o1 on t.bill_time = o1.bill_time
left join (
    select bill_time,sum(receive_amount) goods_count
    from t_order where bill_time in (select bill_time from tem) and supplier_id = ?supplier_id
    group by bill_time
) o2 on t.bill_time = o2.bill_time
left join (
    select bill_time,sum(COALESCE(receive_amount,0) * COALESCE(buy_from_supplier_price,0)) not_receive_amount
    from t_order
    where bill_time in (select bill_time from tem)
    {% if is_admin == 1  %}
        and supplier_settle_status = 2
    {% else %}
        and (supplier_settle_status = 2 or supplier_settle_status = 3)
    {% endif%}
    and supplier_id = ?supplier_id
    group by bill_time
) o3 on t.bill_time = o3.bill_time
left join (
    select bill_time,count(*) order_count
    from t_order where bill_time in (select bill_time from tem) and supplier_id = ?supplier_id
    group by bill_time
) o4 on t.bill_time = o4.bill_time
left join (
    select count(c.*) customer_count,c.bill_time from (
        select customer_id,bill_time
        from t_order
        where bill_time in (select bill_time from tem) and supplier_id = ?supplier_id
        group by bill_time,customer_id
    ) c group by bill_time
) o5 on t.bill_time = o5.bill_time
order by t.bill_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.check.bills.all.cnt]]
select count(1) from (
   select ocb.supplier_check_bill_time, c1.id customer_id,c1.name customer_name,c1.parent_customer_id
   from t_order_check_bill ocb
     left join t_order o on ocb.order_id = o.id
     left join t_customer c1 on c1.id = o.customer_id
   where 1 = 1 and ocb.supplier_check_bill_time is not null
   and o.supplier_id = ?supplier_id
   {% if bill_time != "" %}
      and ocb.supplier_check_bill_time = ?bill_time
   {% endif %}
   {% if group_id!="" %}
      and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
   {% endif%}
   {% if keyword!="" %}
      and c1.name ilike '%'||?keyword||'%'
   {% endif%}
   group by ocb.supplier_check_bill_time , c1.id
) z

[[supplier.check.bills.all.list]]
with tem as (
    select ocb.supplier_check_bill_time, c1.id customer_id,c1.name customer_name,c1.parent_customer_id from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
    where 1 = 1 and ocb.supplier_check_bill_time is not null
    and o.supplier_id = ?supplier_id
   {% if bill_time != "" %}
      and ocb.supplier_check_bill_time = ?bill_time
   {% endif %}
   {% if keyword!="" %}
      and c1.name ilike '%'||?keyword||'%'
   {% endif%}
   {% if group_id!="" %}
      and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
   {% endif%}
    group by ocb.supplier_check_bill_time , c1.id
)
select
    ROW_NUMBER () OVER (ORDER BY t.customer_id desc) AS row_num,
    t.customer_id,
    t.customer_name,
    t.parent_customer_id,
    t.supplier_check_bill_time,
    COALESCE(o1.shipped_cnt,0) shipped_cnt,
    COALESCE(o1.shipped_amount,0) shipped_amount,
    COALESCE(o2.arrived_count,0) arrived_count,
    COALESCE(o2.arrived_amount,0) arrived_amount,
    COALESCE(o3.customer_received_count,0) customer_received_count,
    COALESCE(o3.supplier_shipped_amount,0) supplier_shipped_amount,
    COALESCE(o3.customer_received_amount,0) customer_received_amount,
    COALESCE(o4.dissent_count,0) dissent_count,
    COALESCE(o4.dissent_amount,0) dissent_amount,
    COALESCE(o5.supplier_receive_count,0) supplier_receive_count,
    COALESCE(o5.supplier_receive_amount,0) supplier_receive_amount,
    COALESCE(o6.supplier_check_count,0) supplier_check_count,
    COALESCE(o6.supplier_check_amount,0) supplier_check_amount,
    COALESCE(o9.supplier_checked_count,0) supplier_checked_count,
    COALESCE(o9.supplier_checked_amount,0) supplier_checked_amount,
    COALESCE(o7.customer_checked_count,0) customer_checked_count,
    COALESCE(o7.customer_checked_amount,0) customer_checked_amount,
    COALESCE(o8.both_checked_count,0) both_checked_count,
    COALESCE(o8.both_checked_amount,0) both_checked_amount
from tem t
left join (
    select count(*) shipped_cnt, sum(o.settle_amount * o.buy_from_supplier_price) shipped_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o1 on t.supplier_check_bill_time = o1.supplier_check_bill_time and t.customer_id = o1.customer_id
left join (
    select count(*) arrived_count, sum(o.settle_amount * o.buy_from_supplier_price) arrived_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and ocb.order_status in (10,13) and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o2 on t.supplier_check_bill_time = o2.supplier_check_bill_time and t.customer_id = o2.customer_id
left join (
    select count(*) customer_received_count, sum(o.settle_amount * o.buy_from_supplier_price) supplier_shipped_amount, sum(o.receive_amount * o.buy_from_supplier_price) customer_received_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o3 on t.supplier_check_bill_time = o3.supplier_check_bill_time and t.customer_id = o3.customer_id
left join (
    select count(*) dissent_count, sum(o.settle_amount * o.buy_from_supplier_price) dissent_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and ocb.order_status in (11,14,15) and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o4 on t.supplier_check_bill_time = o4.supplier_check_bill_time and t.customer_id = o4.customer_id
left join (
    select count(*) supplier_receive_count, sum(o.settle_amount * o.buy_from_supplier_price) supplier_receive_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and ocb.order_status in (2) and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o5 on t.supplier_check_bill_time = o5.supplier_check_bill_time and t.customer_id = o5.customer_id
left join (
    select count(*) supplier_check_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) supplier_check_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and ocb.supplier_check_status != 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o6 on t.supplier_check_bill_time = o6.supplier_check_bill_time and t.customer_id = o6.customer_id
left join (
    select count(*) customer_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) customer_checked_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and ocb.customer_check_status = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o7 on t.supplier_check_bill_time = o7.supplier_check_bill_time and t.customer_id = o7.customer_id
left join (
    select count(*) both_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) both_checked_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and ocb.supplier_check_status = 1 and ocb.customer_check_status = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o8 on t.supplier_check_bill_time = o8.supplier_check_bill_time and t.customer_id = o8.customer_id
left join (
    select count(*) supplier_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) supplier_checked_amount,ocb.supplier_check_bill_time , o.customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_goods g on g.id = o.goods_id
      left join t_customer c on c.id = o.customer_id
    where 1 = 1 and ocb.order_status in (9,12) and ocb.supplier_check_status = 1 and o.supplier_id = ?supplier_id
      {% if cate_lv1_id!="" %}
         and g.cate_lv1_id = ?cate_lv1_id
      {% endif%}
      {% if cate_lv2_id!="" %}
         and g.cate_lv2_id = ?cate_lv2_id
      {% endif%}
      {% if prd_id!="" %}
         and g.prd_id = ?prd_id
      {% endif%}
      {% if !begin_order_time.IsZero() %}
         and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_time.IsZero() %}
         and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_ship_time.IsZero() %}
         and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_ship_time.IsZero() %}
         and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if !begin_order_sign_time.IsZero() %}
         and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
      {% endif%}
      {% if !end_order_sign_time.IsZero() %}
         and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
      {% endif%}
      {% if group_id!="" %}
         and o.customer_id in (select customer_id from t_group_customer where status = 1 and group_id = ?group_id)
      {% endif%}
      {% if keyword!="" %}
         and c.name ilike '%'||?keyword||'%'
      {% endif%}
    group by ocb.supplier_check_bill_time , o.customer_id
) o9 on t.supplier_check_bill_time = o9.supplier_check_bill_time and t.customer_id = o9.customer_id
order by t.customer_id desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.check.bills.all.shipped.cnt]]
select count(1) from (
   select ocb.supplier_check_bill_time, c2.id parent_customer_id,c2.name parent_customer_name
   from t_order_check_bill ocb
     left join t_order o on ocb.order_id = o.id
     left join t_customer c1 on c1.id = o.customer_id
     left join t_customer c2 on c2.id = c1.parent_customer_id
   where 1 = 1 and ocb.supplier_check_bill_time is not null
   and o.supplier_id = ?supplier_id
   {% if bill_time != "" %}
      and ocb.supplier_check_bill_time = ?bill_time
   {% endif %}
   {% if parent_customer_id != "" %}
      and c2.id = ?parent_customer_id
   {% endif %}
   group by ocb.supplier_check_bill_time , c2.id
) z

[[supplier.check.bills.all.shipped.list]]
with tem as (
    select ocb.supplier_check_bill_time, c2.id parent_customer_id,c2.name parent_customer_name from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.supplier_check_bill_time is not null
    and o.supplier_id = ?supplier_id
    {% if bill_time != "" %}
       and ocb.supplier_check_bill_time = ?bill_time
    {% endif %}
    {% if parent_customer_id != "" %}
       and c2.id = ?parent_customer_id
    {% endif %}
    group by ocb.supplier_check_bill_time , c2.id
)
select
    ROW_NUMBER () OVER (ORDER BY t.supplier_check_bill_time desc) AS row_num,
    t.parent_customer_id,
    t.parent_customer_name,
    t.supplier_check_bill_time,
    COALESCE(o1.shipped_cnt,0) shipped_cnt,
    COALESCE(o1.shipped_amount,0) shipped_amount,
    COALESCE(o2.arrived_count,0) arrived_count,
    COALESCE(o2.arrived_amount,0) arrived_amount,
    COALESCE(o3.customer_received_count,0) customer_received_count,
    COALESCE(o3.supplier_shipped_amount,0) supplier_shipped_amount,
    COALESCE(o3.customer_received_amount,0) customer_received_amount,
    COALESCE(o4.dissent_count,0) dissent_count,
    COALESCE(o4.dissent_amount,0) dissent_amount,
    COALESCE(o5.supplier_receive_count,0) supplier_receive_count,
    COALESCE(o5.supplier_receive_amount,0) supplier_receive_amount
from tem t
left join (
    select count(*) shipped_cnt, sum(o.settle_amount * o.buy_from_supplier_price) shipped_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o1 on t.supplier_check_bill_time = o1.supplier_check_bill_time and t.parent_customer_id = o1.parent_customer_id
left join (
    select count(*) arrived_count, sum(o.settle_amount * o.buy_from_supplier_price) arrived_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.order_status in (10,13) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o2 on t.supplier_check_bill_time = o2.supplier_check_bill_time and t.parent_customer_id = o2.parent_customer_id
left join (
    select count(*) customer_received_count, sum(o.settle_amount * o.buy_from_supplier_price) supplier_shipped_amount, sum(o.receive_amount * o.buy_from_supplier_price) customer_received_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o3 on t.supplier_check_bill_time = o3.supplier_check_bill_time and t.parent_customer_id = o3.parent_customer_id
left join (
    select count(*) dissent_count, sum(o.settle_amount * o.buy_from_supplier_price) dissent_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.order_status in (11,14,15) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o4 on t.supplier_check_bill_time = o4.supplier_check_bill_time and t.parent_customer_id = o4.parent_customer_id
left join (
    select count(*) supplier_receive_count, sum(o.settle_amount * o.buy_from_supplier_price) supplier_receive_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.order_status in (2) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o5 on t.supplier_check_bill_time = o5.supplier_check_bill_time and t.parent_customer_id = o5.parent_customer_id
order by t.supplier_check_bill_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.check.bills.receipted.cnt]]
select count(1) from (
   select ocb.supplier_check_bill_time, c2.id parent_customer_id,c2.name parent_customer_name
   from t_order_check_bill ocb
     left join t_order o on ocb.order_id = o.id
     left join t_customer c1 on c1.id = o.customer_id
     left join t_customer c2 on c2.id = c1.parent_customer_id
   where 1 = 1 and ocb.supplier_check_bill_time is not null
   and o.supplier_id = ?supplier_id
   {% if bill_time != "" %}
      and ocb.supplier_check_bill_time = ?bill_time
   {% endif %}
   {% if parent_customer_id != "" %}
      and c2.id = ?parent_customer_id
   {% endif %}
   group by ocb.supplier_check_bill_time , c2.id
) z

[[supplier.check.bills.receipted.list]]
with tem as (
    select ocb.supplier_check_bill_time, c2.id parent_customer_id,c2.name parent_customer_name from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.supplier_check_bill_time is not null
    and o.supplier_id = ?supplier_id
    {% if bill_time != "" %}
       and ocb.supplier_check_bill_time = ?bill_time
    {% endif %}
    {% if parent_customer_id != "" %}
       and c2.id = ?parent_customer_id
    {% endif %}
    group by ocb.supplier_check_bill_time , c2.id
)
select
    ROW_NUMBER () OVER (ORDER BY t.supplier_check_bill_time desc) AS row_num,
     CASE WHEN t.supplier_check_bill_time = to_char(now()::timestamp+ '-1 month','YYYYMM') THEN 1 ELSE 2 END operate_status,
    t.parent_customer_id,
    t.parent_customer_name,
    t.supplier_check_bill_time,
    COALESCE(o1.supplier_check_count,0) supplier_check_count,
    COALESCE(o1.supplier_check_amount,0) supplier_check_amount,
    COALESCE(o2.customer_checked_count,0) customer_checked_count,
    COALESCE(o2.customer_checked_amount,0) customer_checked_amount,
    COALESCE(o3.both_checked_count,0) both_checked_count,
    COALESCE(o3.both_checked_amount,0) both_checked_amount,
    COALESCE(o4.customer_received_count,0) customer_received_count,
    COALESCE(o4.customer_received_amount,0) customer_received_amount,
    COALESCE(o4.supplier_shipped_amount,0) supplier_shipped_amount,
    COALESCE(o5.supplier_checked_count,0) supplier_checked_count,
    COALESCE(o5.supplier_checked_amount,0) supplier_checked_amount
from tem t
left join (
    select count(*) supplier_check_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) supplier_check_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.supplier_check_status != 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o1 on t.supplier_check_bill_time = o1.supplier_check_bill_time and t.parent_customer_id = o1.parent_customer_id
left join (
    select count(*) customer_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) customer_checked_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.customer_check_status = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o2 on t.supplier_check_bill_time = o2.supplier_check_bill_time and t.parent_customer_id = o2.parent_customer_id
left join (
    select count(*) both_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) both_checked_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.supplier_check_status = 1 and ocb.customer_check_status = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o3 on t.supplier_check_bill_time = o3.supplier_check_bill_time and t.parent_customer_id = o3.parent_customer_id
left join (
    select count(*) customer_received_count, sum(o.settle_amount * o.buy_from_supplier_price) supplier_shipped_amount, sum(ocb.supplier_amount * o.buy_from_supplier_price) customer_received_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o4 on t.supplier_check_bill_time = o4.supplier_check_bill_time and t.parent_customer_id = o4.parent_customer_id
left join (
    select count(*) supplier_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) supplier_checked_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.order_status in (9,12) and ocb.supplier_check_status = 1 and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o5 on t.supplier_check_bill_time = o5.supplier_check_bill_time and t.parent_customer_id = o5.parent_customer_id
order by t.supplier_check_bill_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.check.bills.unreceipted.cnt]]
select count(1) from (
   select ocb.supplier_check_bill_time, c2.id parent_customer_id,c2.name parent_customer_name
   from t_order_check_bill ocb
     left join t_order o on ocb.order_id = o.id
     left join t_customer c1 on c1.id = o.customer_id
     left join t_customer c2 on c2.id = c1.parent_customer_id
   where 1 = 1 and ocb.supplier_check_bill_time is not null
   and o.supplier_id = ?supplier_id
   {% if bill_time != "" %}
      and ocb.supplier_check_bill_time = ?bill_time
   {% endif %}
   {% if parent_customer_id != "" %}
      and c2.id = ?parent_customer_id
   {% endif %}
   group by ocb.supplier_check_bill_time , c2.id
) z

[[supplier.check.bills.unreceipted.list]]
with tem as (
    select ocb.supplier_check_bill_time, c2.id parent_customer_id,c2.name parent_customer_name from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.supplier_check_bill_time is not null
    and o.supplier_id = ?supplier_id
   {% if bill_time != "" %}
      and ocb.supplier_check_bill_time = ?bill_time
   {% endif %}
   {% if parent_customer_id != "" %}
      and c2.id = ?parent_customer_id
   {% endif %}
    group by ocb.supplier_check_bill_time , c2.id
)
select
    ROW_NUMBER () OVER (ORDER BY t.supplier_check_bill_time desc) AS row_num,
    t.parent_customer_id,
    t.parent_customer_name,
    t.supplier_check_bill_time,
    COALESCE(o1.customer_receive_count,0) customer_receive_count,
    COALESCE(o1.customer_receive_amount,0) customer_receive_amount
from tem t
left join (
    select count(*) customer_receive_count, sum(o.settle_amount * o.buy_from_supplier_price) customer_receive_amount,ocb.supplier_check_bill_time , c2.id parent_customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.order_status not in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c2.id
) o1 on t.supplier_check_bill_time = o1.supplier_check_bill_time and t.parent_customer_id = o1.parent_customer_id
order by t.supplier_check_bill_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.check.bill.by.pcust.cnt]]
select DISTINCT c2.id customer_id,c2.name customer_name
from t_order o
 left join t_customer c on c.id = o.customer_id
 left join t_customer c2 on c.parent_customer_id = c2.id
where c2.id is not null
 and supplier_id = ?supplier_id
 and supplier_check_bill_time = ?bill_time
{% if p_customer_id != "" %}
   and c2.id = ?p_customer_id
{% endif %}

[[supplier.check.bill.by.pcust.list]]
with tem as (
    select DISTINCT c2.id customer_id,c2.name customer_name
    from t_order o
      left join t_customer c on c.id = o.customer_id
      left join t_customer c2 on c.parent_customer_id = c2.id
    where c2.id is not null
      and supplier_id = ?supplier_id
      and supplier_check_bill_time = ?bill_time
      {% if p_customer_id != "" %}
         and c2.id = ?p_customer_id
      {% endif %}
)
select
    ROW_NUMBER () OVER (ORDER BY t.supplier_check_bill_time desc) AS row_num,
    t.customer_name,
    o1.bill_order_count,
    o1.bill_order_amount,
    o2.checked_count,
    o2.checked_amount,
    o3.check_count,
    o3.check_amount
from tem t
left join (
    select c2.id customer_id,count(*) bill_order_count,
        sum( case when order_status in (2) then COALESCE(order_amount * 100,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (9,10,11) then COALESCE(w_receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (13) then COALESCE(settle_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (12) then COALESCE(receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (14,15) then COALESCE(s_receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             else 0 end) bill_order_amount
    from t_order o
      left join t_customer c on c.id = o.customer_id
      left join t_customer c2 on c.parent_customer_id = c2.id
    where c2.id is not null
        and o.supplier_check_bill_time = ?bill_time
        and o.supplier_id = ?supplier_id
    group by c2.id
) o1 on t.customer_id = o1.customer_id
left join (
    select c2.id customer_id,count(*) checked_count,
        sum( case when order_status in (2) then COALESCE(order_amount * 100,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (9,10,11) then COALESCE(w_receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (13) then COALESCE(settle_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (12) then COALESCE(receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (14,15) then COALESCE(s_receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             else 0 end) checked_amount
    from t_order o
      left join t_customer c on c.id = o.customer_id
      left join t_customer c2 on c.parent_customer_id = c2.id
    where c2.id is not null
      and supplier_check_status = 1
      and o.supplier_check_bill_time = ?bill_time
      and o.supplier_id = ?supplier_id
    group by c2.id
) o2 on t.customer_id = o2.customer_id
left join (
    select c2.id customer_id,
        count(*) check_count,
        sum(case when order_status in (2) then COALESCE(order_amount * 100,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (9,10,11) then COALESCE(w_receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (13) then COALESCE(settle_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (12) then COALESCE(receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             when order_status in (14,15) then COALESCE(s_receive_amount,0) * COALESCE(buy_from_supplier_price,0)
             else 0 end) check_amount
    from t_order o
      left join t_customer c on c.id = o.customer_id
      left join t_customer c2 on c.parent_customer_id = c2.id
    where c2.id is not null
      and supplier_check_status = 2
      and o.supplier_check_bill_time = ?bill_time
      and o.supplier_id = ?supplier_id
    group by c2.id
) o3 on t.customer_id = o3.customer_id
order by t.customer_id desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.financial.bill.list.export]]
with tem as (
    select bill_time
    from t_order where bill_time is not null and supplier_id = ?supplier_id
    {% if bill_time != "" %}
       and bill_time = ?bill_time
    {% endif %}
    group by bill_time
)
select
    ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
    t.bill_time,
    o1.supplier_settle_count,
    o1.receive_amount,
    o3.not_receive_amount,
    o2.goods_count,
    o4.order_count,
    o5.customer_count
from tem t
left join (
    select bill_time,count(*) supplier_settle_count,sum(COALESCE(receive_amount,0) * COALESCE(buy_from_supplier_price,0)) receive_amount
    from t_order
    where bill_time in (select bill_time from tem)
    {% if is_admin == 1  %}
        and (supplier_settle_status = 1 or supplier_settle_status = 3)
    {% else %}
        and supplier_settle_status = 1
    {% endif%}
    and supplier_id = ?supplier_id
    group by bill_time
) o1 on t.bill_time = o1.bill_time
left join (
    select bill_time,sum(receive_amount) goods_count
    from t_order where bill_time in (select bill_time from tem) and supplier_id = ?supplier_id
    group by bill_time
) o2 on t.bill_time = o2.bill_time
left join (
    select bill_time,sum(COALESCE(receive_amount,0) * COALESCE(buy_from_supplier_price,0)) not_receive_amount
    from t_order
    where bill_time in (select bill_time from tem)
    {% if is_admin == 1  %}
        and supplier_settle_status = 2
    {% else %}
        and (supplier_settle_status = 2 or supplier_settle_status = 3)
    {% endif%}
    and supplier_id = ?supplier_id
    group by bill_time
) o3 on t.bill_time = o3.bill_time
left join (
    select bill_time,count(*) order_count
    from t_order where bill_time in (select bill_time from tem) and supplier_id = ?supplier_id
    group by bill_time
) o4 on t.bill_time = o4.bill_time
left join (
    select count(c.*) customer_count,c.bill_time from (
        select customer_id,bill_time
        from t_order
        where bill_time in (select bill_time from tem) and supplier_id = ?supplier_id
        group by bill_time,customer_id
    ) c group by bill_time
) o5 on t.bill_time = o5.bill_time
order by t.bill_time desc

[[jt.financial.bill.order.cnt]]
SELECT
  count(1)
FROM t_order o
left join t_goods g on o.goods_id = g.id
where o.customer_id = ?customer_id and o.bill_time = ?bill_time
{% if supplier_id != "" %}
and o.supplier_id = ?supplier_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}

[[jt.financial.bill.order.list]]
with temp as (
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  g.unit,
  o.receive_amount,
  o.w_receive_amount,
  o.s_receive_amount,
  o.sale_to_customer_price,
  o.sale_to_customer_price * o.receive_amount finish_amt,
  (CASE WHEN o.customer_settle_status = 1
    THEN '已结单'
   WHEN o.customer_settle_status = 2
     THEN '未结单' END) status_desc,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time,
  o.supplier_settle_time,
  o.order_sign_time,
  o.customer_id,
  o.customer_settle_status,
  o.supplier_settle_status,
  o.order_status,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已收款'
       WHEN o.supplier_settle_status = 2 THEN '中心未打款'
       ELSE '中心已打款' END supplier_settle_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '中心已收款'
       WHEN o.customer_settle_status = 2 THEN '客户未打款'
       ELSE '客户已打款' END customer_settle_status_desc,
  s.name supplier_name
FROM t_order o
left join t_goods g on o.goods_id = g.id
left join t_supplier s on o.supplier_id = s.id
where o.customer_id = ?customer_id and o.bill_time = ?bill_time
{% if supplier_id != "" %}
and o.supplier_id = ?supplier_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}
order by o.order_time desc,o.order_no,o.order_sub_no
limit ?page_size offset (?page_num - 1) * ?page_size
)
select temp.*,cus.name customer_name from temp left join t_customer cus on cus.id = temp.customer_id

[[jt.financial.check.bill.order.cnt]]
SELECT
  count(1)
FROM t_order o
left join t_goods g on o.goods_id = g.id
where o.customer_id = ?customer_id and o.customer_check_bill_time = ?bill_time
{% if supplier_id != "" %}
and o.supplier_id = ?supplier_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if check_status != "" %}
and o.customer_check_status = ?check_status
{% endif %}

[[jt.financial.check.bill.order.list]]
with temp as (
SELECT
  o.*,
  g.unit,
  o.sale_to_customer_price * o.receive_amount finish_amt,
  o.sale_to_customer_price * o.receive_amount cus_receive_total_amt,
  (CASE WHEN o.customer_settle_status = 1
    THEN '已结单'
   WHEN o.customer_settle_status = 2
     THEN '未结单' END) status_desc,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已收款'
       WHEN o.supplier_settle_status = 2 THEN '中心未打款'
       ELSE '中心已打款' END supplier_settle_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '中心已收款'
       WHEN o.customer_settle_status = 2 THEN '客户未打款'
       ELSE '客户已打款' END customer_settle_status_desc,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已对账'
       WHEN o.supplier_settle_status = 2 THEN '供应商未对账'
       ELSE '未知' END supplier_check_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '客户已对账'
       WHEN o.customer_settle_status = 2 THEN '客户未对账'
       ELSE '未知' END customer_check_status_desc,
  s.name supplier_name
FROM t_order o
left join t_goods g on o.goods_id = g.id
left join t_supplier s on o.supplier_id = s.id
where o.customer_id = ?customer_id and o.customer_check_bill_time = ?bill_time
{% if supplier_id != "" %}
and o.supplier_id = ?supplier_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if check_status != "" %}
and o.customer_check_status = ?check_status
{% endif %}
order by o.order_time desc,o.order_no,o.order_sub_no
limit ?page_size offset (?page_num - 1) * ?page_size
)
select temp.*,cus.name customer_name from temp left join t_customer cus on cus.id = temp.customer_id

[[jt.financial.bill.order.list.export]]
with temp as (
SELECT
  o.id,
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  g.unit,
  o.receive_amount,
  o.sale_to_customer_price,
  o.sale_to_customer_price * o.receive_amount finish_amt,
  (CASE WHEN o.customer_settle_status = 1
    THEN '已结单'
   WHEN o.customer_settle_status = 2
     THEN '未结单' END) status_desc,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_time,
  o.supplier_settle_time,
  o.order_sign_time,
  o.customer_id,
  o.customer_settle_status,
  o.supplier_settle_status,
  o.order_status,
  CASE WHEN o.supplier_settle_status = 1 THEN '供应商已收款'
       WHEN o.supplier_settle_status = 2 THEN '中心未打款'
       ELSE '中心已打款' END supplier_settle_status_desc,
  CASE WHEN o.customer_settle_status = 1 THEN '中心已收款'
       WHEN o.customer_settle_status = 2 THEN '客户未打款'
       ELSE '客户已打款' END customer_settle_status_desc,
  s.name supplier_name
FROM t_order o
left join t_goods g on o.goods_id = g.id
left join t_supplier s on o.supplier_id = s.id
where o.customer_id = ?customer_id and o.bill_time = ?bill_time
{% if supplier_id != "" %}
and o.supplier_id = ?supplier_id
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if settle_status != "" %}
and o.customer_settle_status = ?settle_status
{% endif %}
order by o.order_time desc,o.order_no,o.order_sub_no
)
select temp.*,cus.name customer_name from temp left join t_customer cus on cus.id = temp.customer_id

[[detail.customer.choose.list]]
SELECT
  DISTINCT o.customer_id id ,c.name
FROM t_order o,t_customer c
WHERE o.supplier_id = ?id and o.bill_time = ?bill_time and o.customer_id = c.id

[[detail.customer.choose.list.for.check]]
SELECT
  DISTINCT o.customer_id id ,c.name
FROM t_order o,t_customer c
WHERE o.supplier_id = ?id and o.supplier_check_bill_time = ?bill_time and o.customer_id = c.id

[[detail.supplier.choose.list]]
SELECT
  DISTINCT o.supplier_id id ,s.name
FROM t_order o,t_supplier s
WHERE o.customer_id = ?id and o.bill_time = ?bill_time and o.supplier_id = s.id

[[detail.supplier.choose.list.for.check]]
SELECT
  DISTINCT o.supplier_id id ,s.name
FROM t_order o,t_supplier s
WHERE o.customer_id = ?id and o.customer_check_bill_time = ?bill_time and o.supplier_id = s.id

[[query.check.bill.by.order.month.cnt]]
WITH tmp as(
  SELECT c.parent_customer_id,
  sum(t.order_count) order_count
  FROM
    t_customer c,(SELECT o.customer_id,count(1) order_count FROM t_order o WHERE o.supplier_check_bill_time = ?supplier_check_bill_time and o.supplier_id = ?supplier_id GROUP BY customer_id) t
WHERE c.id = t.customer_id
GROUP BY c.parent_customer_id
)
SELECT count(1) cnt FROM tmp

[[query.check.bill.by.order.month.list]]
WITH tmp as(
  SELECT c.parent_customer_id,
  sum(t.order_count) order_count
  FROM
    t_customer c,(SELECT o.customer_id,count(1) order_count FROM t_order o WHERE o.supplier_check_bill_time = ?supplier_check_bill_time and o.supplier_id = ?supplier_id GROUP BY customer_id) t
WHERE c.id = t.customer_id
GROUP BY c.parent_customer_id
)
SELECT t.*,c.name parent_customer_name FROM tmp t
INNER JOIN t_customer c ON c.id = t.parent_customer_id

[[query.check.bill.by.order.jt.cnt]]
WITH tmp as(
SELECT o.customer_id,count(1) order_count FROM t_order o WHERE o.supplier_check_bill_time = ?supplier_check_bill_time and o.supplier_id = ?supplier_id GROUP BY o.customer_id
)
SELECT count(1) cnt FROM tmp t
INNER JOIN t_customer c ON c.id = t.customer_id and c.parent_customer_id = ?parent_customer_id

[[query.check.bill.by.order.jt.list]]
WITH tmp as(
SELECT o.customer_id,count(1) order_count FROM t_order o WHERE o.supplier_check_bill_time = '20180101' and o.supplier_id = ?supplier_id GROUP BY o.customer_id
)
SELECT t.*,c.name customer_name FROM tmp t
INNER JOIN t_customer c ON c.id = t.customer_id and c.parent_customer_id = ?parent_customer_id

[[supplier.check.bill.detail.cnt]]
select
  count(*) total_count,
  COALESCE(sum(o.order_amount ),0) order_count ,
  COALESCE(sum(o.settle_amount ),0) ship_count ,
  COALESCE(sum(o.receive_amount ),0) receive_count ,
  COALESCE(sum(COALESCE(o.receive_amount,0)*spec_scaling),0) spec_count ,
  COALESCE(sum(o.settle_amount * o.buy_from_supplier_price),0) total_settle_amount ,
  COALESCE(sum(o.receive_amount * o.buy_from_supplier_price),0) total_receive_amount ,
  COALESCE(sum(
     case when ocb.supplier_check_status = 1 then o.receive_amount * o.buy_from_supplier_price else 0 end
           ),0) total_checked_amount
from t_order_check_bill ocb
  left join t_order o on o.id = ocb.order_id
  left join t_goods g on g.id = o.goods_id
  left join t_customer c on c.id = o.customer_id
  left join t_customer pc on pc.id = c.parent_customer_id
where 1=1 and o.supplier_id = ?supplier_id and pc.id = ?parent_customer_id
  and ocb.supplier_check_bill_time = ?bill_time
  {% if cate_lv1_id!="" %}
  and g.cate_lv1_id=?cate_lv1_id
  {% endif%}
  {% if cate_lv2_id!="" %}
  and g.cate_lv2_id=?cate_lv2_id
  {% endif%}
  {% if prd_id!="" %}
  and g.prd_id=?prd_id
  {% endif%}
{% if customer_id != "" %}
   and o.customer_id = ?customer_id
{% endif %}
{% if month_data != "" %}
and  to_char(o.ship_time,'YYYY-MM')  =  ?month_data
{% endif %}
{% if dissent_time == 1 %}
   and to_char(o.ship_time , 'YYYYMM') < ?bill_time and ocb.supplier_check_status = 3
{% endif %}
{% if dissent_time == 2 %}
   and to_char(o.ship_time , 'YYYYMM') = ?bill_time and ocb.supplier_check_status = 3
{% endif %}
{% if sign_status == 1 %}
   and ocb.order_status in (9,12)
{% endif %}
{% if sign_status == 2 %}
   and ocb.order_status not in (9,12)
{% endif %}
{% if !order_time_start.IsZero %}
   and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
   and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
   and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
   and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
   and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
   and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if customer_check_status != 0 %}
   and ocb.customer_check_status = ?customer_check_status
{% endif %}
{% if supplier_check_status != 0 %}
   and ocb.supplier_check_status = ?supplier_check_status
{% endif %}
{% if keyword != "" %}
   and (g.name ilike '%'|| ?keyword ||'%' or o.order_no ilike '%'|| ?keyword ||'%')
{% endif %}

[[supplier.check.bill.detail.list]]
select
  ROW_NUMBER () OVER (ORDER BY cast(ocb.order_id as integer) desc) AS row_num,
  CASE WHEN ocb.supplier_check_bill_time = to_char(now()::timestamp+ '-1 month','YYYYMM') and o.order_status in (9,12) and ocb.supplier_check_status != 1 THEN 1 ELSE 2 END operate_status,
  ocb.id,
  ocb.order_id,
  c.id customer_id,
  c.name customer_name,
  o.order_no,
  o.order_sub_no,
  g.name goods_name,
  case when ocb.supplier_check_status = 1 then ocb.supplier_amount else 0 end ship_count,
  case when ocb.supplier_check_status = 1 then o.buy_from_supplier_price * ocb.supplier_amount else 0 end ship_amount,
  o.settle_amount settle_count,
  o.buy_from_supplier_price * o.settle_amount settle_amount,
  case when o.order_status in (2,13) then o.order_amount * 100
       when o.order_status in (9,12) then o.receive_amount
       when  o.order_status in (10,11) then o.w_receive_amount
       when  o.order_status in (14,15) then o.s_receive_amount
       else 0 end rel_receive_count,
  case when o.order_status in (2,13) then o.order_amount * 100 * o.buy_from_supplier_price
       when o.order_status in (9,12) then o.receive_amount * o.buy_from_supplier_price
       when  o.order_status in (10,11) then o.w_receive_amount * o.buy_from_supplier_price
       when  o.order_status in (14,15) then o.s_receive_amount * o.buy_from_supplier_price
       else 0 end rel_receive_amount,
  o.order_status,
  ocb.order_status supplier_check_order_status,
  o.buy_from_supplier_price,
  o.order_time,
  o.ship_time,
  o.order_sign_time,
  ocb.supplier_check_status,
  ocb.customer_check_status,
  ocb.supplier_check_reason,
  ocb.customer_check_reason,
  ocb.supplier_doubt_time,
  ocb.customer_doubt_time,
  a1.name supplier_doubt_account_name,
  a2.name customer_doubt_account_name,
  o.receive_amount,
  o.w_receive_amount,
  o.s_receive_amount,
  COALESCE(o.receive_amount,0)*spec_scaling spec_amount ,
  o.unit,
  CASE WHEN ocb.supplier_check_status = 1 THEN '供应商已对账'
         WHEN ocb.supplier_check_status = 2 THEN '供应商未对账'
         WHEN ocb.supplier_check_status = 3 AND to_char(o.ship_time , 'YYYYMM') < ?bill_time  THEN '供应商置为问题单'
         WHEN ocb.supplier_check_status = 3 AND to_char(o.ship_time , 'YYYYMM') = ?bill_time  THEN '供应商置为问题单'
    ELSE '未知' END supplier_check_status_desc,
  CASE WHEN ocb.customer_check_status = 1 THEN '客户已对账'
         WHEN ocb.customer_check_status = 2 THEN '客户未对账'
         WHEN ocb.customer_check_status = 3 AND to_char(o.receive_time , 'YYYYMM') < ?bill_time  THEN '客户置为问题单'
         WHEN ocb.customer_check_status = 3 AND to_char(o.receive_time , 'YYYYMM') = ?bill_time  THEN '客户置为问题单'
    ELSE '未知' END customer_check_status_desc
from t_order_check_bill ocb
  left join t_order o on o.id = ocb.order_id
  left join t_goods g on g.id = o.goods_id
  left join t_customer c on c.id = o.customer_id
  left join t_customer pc on pc.id = c.parent_customer_id
  left join t_account a1 on a1.id = ocb.supplier_doubt_account_id
  left join t_account a2 on a2.id = ocb.customer_doubt_account_id
where 1=1 and o.supplier_id = ?supplier_id and pc.id = ?parent_customer_id
  and ocb.supplier_check_bill_time = ?bill_time
  {% if cate_lv1_id!="" %}
  and g.cate_lv1_id=?cate_lv1_id
  {% endif%}
  {% if cate_lv2_id!="" %}
  and g.cate_lv2_id=?cate_lv2_id
  {% endif%}
  {% if prd_id!="" %}
  and g.prd_id=?prd_id
  {% endif%}
{% if customer_id != "" %}
   and o.customer_id = ?customer_id
{% endif %}
{% if month_data != "" %}
and  to_char(o.ship_time,'YYYY-MM')  =  ?month_data
{% endif %}
{% if dissent_time == 1 %}
   and to_char(o.ship_time , 'YYYYMM') < ?bill_time and ocb.supplier_check_status = 3
{% endif %}
{% if dissent_time == 2 %}
   and to_char(o.ship_time , 'YYYYMM') = ?bill_time and ocb.supplier_check_status = 3
{% endif %}
{% if sign_status == 1 %}
   and ocb.order_status in (9,12)
{% endif %}
{% if sign_status == 2 %}
   and ocb.order_status not in (9,12)
{% endif %}
{% if !order_time_start.IsZero %}
   and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
   and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
   and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
   and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_sign_time_start.IsZero %}
   and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
   and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if customer_check_status != 0 %}
   and ocb.customer_check_status = ?customer_check_status
{% endif %}
{% if supplier_check_status != 0 %}
   and ocb.supplier_check_status = ?supplier_check_status
{% endif %}
{% if keyword != "" %}
   and (g.name ilike '%'|| ?keyword ||'%' or o.order_no ilike '%'|| ?keyword ||'%')
{% endif %}
order by o.id desc
{% if is_export != 1 %}
   limit ?page_size offset (?page_num - 1) * ?page_size
{% endif %}

[[query.check.bill.for.option.cnt]]
SELECT count(1) cnt FROM t_order o
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
INNER JOIN t_order_check_bill ocb ON ocb.order_id = o.id

[[query.check.bill.for.option.list]]
SELECT DISTINCT ocb.customer_check_bill_time as name,ocb.customer_check_bill_time as id FROM t_order o
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
INNER JOIN t_order_check_bill ocb ON ocb.order_id = o.id AND ocb.customer_check_bill_time NOTNULL
ORDER BY ocb.customer_check_bill_time desc

[[query.supplier.by.cus.bill.for.option.cnt]]
SELECT count(1) cnt FROM t_order o
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
INNER JOIN t_order_check_bill ocb ON ocb.order_id = o.id
INNER JOIN t_supplier s ON s.id = o.supplier_id
left join t_supplier_alias sa ON sa.id = o.supplier_alias_id

[[query.supplier.by.cus.bill.for.option.list]]
SELECT DISTINCT
s.id||'--'||coalesce(sa.id,'0') as id,
case when sa.id is null then s.name else sa.supplier_alias_name end as  name
  FROM t_order o
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
INNER JOIN t_order_check_bill ocb ON ocb.order_id = o.id
INNER JOIN t_supplier s ON s.id = o.supplier_id
left join t_supplier_alias sa ON sa.id = o.supplier_alias_id
ORDER BY s.id||'--'||coalesce(sa.id,'0')

[[query.cus.bill.by.month.sup.cnt]]
with tmp as (
SELECT count(1) cnt FROM t_order o
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
INNER JOIN t_order_check_bill ocb ON o.id = ocb.order_id
LEFT JOIN t_order_check_bill ocb1 ON o.id = ocb1.order_id AND ocb1.customer_check_status = 2 AND ocb.customer_check_bill_time = ocb1.customer_check_bill_time
LEFT JOIN t_order_check_bill ocb2 ON o.id = ocb2.order_id AND ocb2.supplier_check_status = 1 AND ocb.customer_check_bill_time = ocb2.supplier_check_bill_time
    WHERE ocb.customer_check_bill_time NOTNULL AND ocb.customer_check_bill_time !=''
{% if supplier_id != "" %}
    and o.supplier_id = ?supplier_id
    {% endif %}
  {% if supplier_alias_id != "" %}
  and o.supplier_alias_id = ?supplier_alias_id
  {% endif %}
    {% if customer_check_bill_time != "" %}
    and ocb.customer_check_bill_time = ?customer_check_bill_time
    {% endif %}
GROUP BY o.supplier_id ,o.supplier_alias_id ,ocb.customer_check_bill_time ORDER BY ocb.customer_check_bill_time DESC
)
select count(1) cnt from tmp

[[query.cus.bill.by.month.sup.list]]
with tmp as (
SELECT count(1) sign_amount, sum( COALESCE (o.sale_to_customer_price * ocb.customer_amount ,0) ) sign_price ,
  count(ocb1.customer_amount) not_bill_amount,sum( COALESCE(o.sale_to_customer_price * ocb1.customer_amount,0)) not_bill_price,
 count(ocb2.customer_amount) double_bill_amount,sum( COALESCE(o.sale_to_customer_price * ocb2.customer_amount,0)) double_bill_price,
  count(ocb3.customer_amount) check_bill_amount,sum( COALESCE(o.sale_to_customer_price * ocb3.customer_amount,0)) check_bill_price,
  o.supplier_id,o.supplier_alias_id,ocb.customer_check_bill_time FROM t_order o
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
INNER JOIN t_order_check_bill ocb ON o.id = ocb.order_id
LEFT JOIN t_order_check_bill ocb3 ON ocb.id = ocb3.id AND ocb3.customer_check_status = 1
LEFT JOIN t_order_check_bill ocb1 ON ocb.id = ocb1.id AND ocb1.customer_check_status  in (2,3)
LEFT JOIN t_order_check_bill ocb2 ON ocb.id = ocb2.id AND ocb2.supplier_check_status = 1 AND ocb2.customer_check_status =1
    WHERE ocb.customer_check_bill_time NOTNULL AND ocb.customer_check_bill_time !=''
{% if supplier_id != "" %}
and o.supplier_id = ?supplier_id
{% endif %}
{% if supplier_alias_id != "" %}
and o.supplier_alias_id = ?supplier_alias_id
{% endif %}
{% if customer_check_bill_time != "" %}
and ocb.customer_check_bill_time = ?customer_check_bill_time
{% endif %}
GROUP BY o.supplier_id,o.supplier_alias_id ,ocb.customer_check_bill_time
)
SELECT tmp.*,CASE WHEN tmp.customer_check_bill_time = to_char(now()::timestamp+ '-1 month','YYYYMM') THEN 1 ELSE 2 END operate_status,
ROW_NUMBER () OVER (ORDER BY tmp.customer_check_bill_time,tmp.supplier_id,tmp.supplier_alias_id  desc) AS row_num,
case when sa.id is null then s.name else sa.supplier_alias_name end supplier_name
FROM tmp
INNER JOIN t_supplier s ON s.id = tmp.supplier_id
LEFT JOIN t_supplier_alias sa ON sa.id = tmp.supplier_alias_id
ORDER BY tmp.customer_check_bill_time desc,tmp.supplier_id,tmp.supplier_alias_id
limit ?page_size offset (?page_num - 1) * ?page_size

[[query.cus.bill.by.month.sup.detail.cnt]]
SELECT
  count(1) cnt
 FROM t_order_check_bill ocb
INNER JOIN t_order o ON o.id = ocb.order_id AND o.supplier_id =?supplier_id AND o.supplier_alias_id =?supplier_alias_id
INNER JOIN t_customer c ON c.id = o.customer_id
INNER JOIN t_goods g ON g.id = o.goods_id
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
LEFT  JOIN (SELECT order_id,count(1) cnt FROM t_order_check_bill ocb WHERE ocb.customer_check_bill_time  <= ?customer_check_bill_time GROUP BY order_id) co ON co.order_id = o.id
LEFT  JOIN (SELECT order_id,count(1) cnt FROM t_order_check_bill ocb WHERE ocb.supplier_check_bill_time  <= ?customer_check_bill_time GROUP BY order_id) co1 ON co1.order_id = o.id
WHERE ocb.customer_check_bill_time = ?customer_check_bill_time
  {% if cate_lv1_id!="" %}
  and g.cate_lv1_id=?cate_lv1_id
  {% endif%}
  {% if cate_lv2_id!="" %}
  and g.cate_lv2_id=?cate_lv2_id
  {% endif%}
  {% if prd_id!="" %}
  and g.prd_id=?prd_id
  {% endif%}
{% if customer_id != "" %}
and o.customer_id= ?customer_id
{% endif %}
{% if month_data != "" %}
and  to_char(o.receive_time,'YYYY-MM')  =  ?month_data
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if keyword!="" %}
  and ( o.goods_name ilike '%'|| ?keyword ||'%' or  CnFirstChar(o.goods_name) ilike '%'|| ?keyword ||'%' or o.order_no ilike '%'|| ?keyword ||'%'  )
{% endif %}
{% if type == 1 %}
  and ocb.customer_check_status = 2
{% endif %}
{% if type == 2 %}
  and ocb.customer_check_status = 3
{% endif %}
{% if type == 3 %}
  and ocb.customer_check_status = 1
{% endif %}
{% if supplier_check_status == 1 %}
  and ocb.supplier_check_status = 1
{% endif %}
{% if supplier_check_status == 2 %}
  and ocb.supplier_check_status = 2
{% endif %}
{% if supplier_check_status == 3 %}
  and ocb.supplier_check_status = 3
{% endif %}

[[query.cus.bill.by.month.sup.detail.list]]
with tmp as(
SELECT
  ocb.id ,
  o.id order_id,
  o.order_no,
  o.order_sub_no,
  o.goods_name,
  o.order_amount,
  o.receive_amount,
  o.w_receive_amount,
  o.s_receive_amount,
  o.receive_amount * g.spec_scaling spec_amount,
  case when o.order_status=1 or o.order_status=2 then 1 else 2 end receive_status,
  CASE WHEN o.receive_time > coalesce(o.verify_time,'0001-01-01') THEN
            CASE WHEN o.receive_time > coalesce(o.order_w_sign_time,'0001-01-01') THEN 3 ELSE 1 END
         ELSE
           CASE WHEN coalesce(o.verify_time,'0001-01-01')  > coalesce(o.order_w_sign_time,'0001-01-01') THEN 2 ELSE 1 END
        END time_ordering,
  o.order_status,
  o.unit,
  o.sale_to_customer_price,
  o.order_time,
  o.ship_time,
  o.order_sign_time,
  o.unit_id,
  c.id customer_id,
   o.supplier_alias_id,
  c.name customer_name,
  case when ocb.customer_check_status = 1 then ocb.customer_amount else 0 end as customer_amount,
  CASE co.cnt WHEN 1 THEN 1 ELSE CASE WHEN co1.cnt ISNULL THEN 3 ELSE 2 END END  as customer_history_desc,
  CASE co1.cnt WHEN 1 THEN 1 ELSE CASE WHEN co1.cnt ISNULL THEN 3 ELSE 2 END END  as supplier_history_desc,
  ocb.customer_check_status,
  ocb.supplier_check_status,
  ocb.customer_check_reason,
  ocb.supplier_check_reason,
  ocb.supplier_doubt_time,
  ocb.customer_doubt_time,
  a1.name supplier_doubt_account_name,
  a2.name customer_doubt_account_name,
  ocb.customer_amount * o.sale_to_customer_price  as total_price,
  o.order_amount * o.sale_to_customer_price  as order_price,
  ocb.customer_amount * o.sale_to_customer_price  as receive_price,
  ocb.customer_check_bill_time,
  COALESCE(o.sale_to_customer_price * ocb1.customer_amount,0)  as double_bill_price
 FROM t_order_check_bill ocb
INNER JOIN t_order o ON o.id = ocb.order_id AND o.supplier_id =?supplier_id AND o.supplier_alias_id =?supplier_alias_id
INNER JOIN t_customer c ON c.id = o.customer_id
INNER JOIN t_goods g ON g.id = o.goods_id
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
LEFT JOIN t_order_check_bill ocb1 ON ocb.id = ocb1.id AND ocb1.customer_check_status = 1
left join t_account a1 on a1.id = ocb.supplier_doubt_account_id
left join t_account a2 on a2.id = ocb.customer_doubt_account_id
LEFT  JOIN (SELECT order_id,count(1) cnt FROM t_order_check_bill ocb WHERE ocb.customer_check_bill_time  <= ?customer_check_bill_time GROUP BY order_id) co ON co.order_id = o.id
LEFT  JOIN (SELECT order_id,count(1) cnt FROM t_order_check_bill ocb WHERE ocb.supplier_check_bill_time  <= ?customer_check_bill_time GROUP BY order_id) co1 ON co1.order_id = o.id
WHERE ocb.customer_check_bill_time = ?customer_check_bill_time
  {% if cate_lv1_id!="" %}
  and g.cate_lv1_id=?cate_lv1_id
  {% endif%}
  {% if cate_lv2_id!="" %}
  and g.cate_lv2_id=?cate_lv2_id
  {% endif%}
  {% if prd_id!="" %}
  and g.prd_id=?prd_id
  {% endif%}
{% if customer_id != "" %}
and o.customer_id= ?customer_id
{% endif %}
{% if month_data != "" %}
and  to_char(o.receive_time,'YYYY-MM')  =  ?month_data
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if keyword!="" %}
  and ( o.goods_name ilike '%'|| ?keyword ||'%' or CnFirstChar(o.goods_name) ilike '%'|| ?keyword ||'%' or o.order_no ilike '%'|| ?keyword ||'%'  )
{% endif %}
{% if type == 1 %}
  and ocb.customer_check_status = 2
{% endif %}
{% if type == 2 %}
  and ocb.customer_check_status = 3
{% endif %}
{% if type == 3 %}
  and ocb.customer_check_status = 1
{% endif %}
{% if supplier_check_status == 1 %}
  and ocb.supplier_check_status = 1
{% endif %}
{% if supplier_check_status == 2 %}
  and ocb.supplier_check_status = 2
{% endif %}
{% if supplier_check_status == 3 %}
  and ocb.supplier_check_status = 3
{% endif %}
)
SELECT t.*,
 CASE WHEN t.customer_check_bill_time = to_char(now()::timestamp+ '-1 month','YYYYMM') THEN 1 ELSE 2 END operate_status,
  CASE t.customer_check_status WHEN 1 THEN '客户确认对账'
                                WHEN 2 THEN '客户未对账'
                               WHEN 3  THEN '客户置为问题单' ELSE '错误' END as customer_check_status_desc,
   CASE t.supplier_check_status WHEN 1 THEN '供应商确认对账'
                                WHEN 2 THEN '供应商未对账'
                               WHEN 3  THEN '供应商置为问题单' ELSE '错误' END as supplier_check_status_desc
FROM tmp t
order by cast(t.order_id as integer) desc
{% if !reportTemp %}
 limit ?page_size offset (?page_num - 1) * ?page_size
{% endif %}

[[query.cus.bottom.total.list]]
with tmp as(
SELECT
  ocb.id ,
  o.order_amount,
  o.settle_amount,
  o.receive_amount,
  o.receive_amount * g.spec_scaling as spec_amount,
  ocb.customer_amount * o.sale_to_customer_price  as total_price,
  o.order_amount * o.sale_to_customer_price  as order_price,
  ocb.customer_amount * o.sale_to_customer_price  as receive_price,
  COALESCE(o.sale_to_customer_price * ocb1.customer_amount,0)  as double_bill_price
 FROM t_order_check_bill ocb
INNER JOIN t_order o ON o.id = ocb.order_id AND o.supplier_id =?supplier_id AND o.supplier_alias_id =?supplier_alias_id
INNER JOIN t_customer c ON c.id = o.customer_id
INNER JOIN t_goods g ON g.id = o.goods_id
INNER JOIN (
     select cs.* from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1
) acc ON o.customer_id = acc.id
LEFT  JOIN t_order_check_bill ocb1 ON ocb.id = ocb1.id AND ocb1.customer_check_status = 1
LEFT  JOIN (SELECT order_id,count(1) cnt FROM t_order_check_bill ocb WHERE ocb.customer_check_bill_time  <= ?customer_check_bill_time GROUP BY order_id) co ON co.order_id = o.id
LEFT  JOIN (SELECT order_id,count(1) cnt FROM t_order_check_bill ocb WHERE ocb.supplier_check_bill_time  <= ?customer_check_bill_time GROUP BY order_id) co1 ON co1.order_id = o.id
WHERE ocb.customer_check_bill_time = ?customer_check_bill_time
  {% if cate_lv1_id!="" %}
  and g.cate_lv1_id=?cate_lv1_id
  {% endif%}
  {% if cate_lv2_id!="" %}
  and g.cate_lv2_id=?cate_lv2_id
  {% endif%}
  {% if prd_id!="" %}
  and g.prd_id=?prd_id
  {% endif%}
{% if customer_id != "" %}
and o.customer_id= ?customer_id
{% endif %}
{% if month_data != "" %}
and  to_char(o.receive_time,'YYYY-MM')  =  ?month_data
{% endif %}
{% if !order_sign_time_start.IsZero %}
and o.order_sign_time >=to_date(?order_sign_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_sign_time_end.IsZero %}
and o.order_sign_time <to_date(?order_sign_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !order_time_start.IsZero %}
and o.order_time >=to_date(?order_time_start,'YYYY-MM-DD')
{% endif %}
{% if !order_time_end.IsZero %}
and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if keyword!="" %}
  and ( o.goods_name ilike '%'|| ?keyword ||'%' or  CnFirstChar(o.goods_name) ilike '%'|| ?keyword ||'%' or o.order_no ilike '%'|| ?keyword ||'%'  )
{% endif %}
{% if type == 1 %}
  and ocb.customer_check_status = 2
{% endif %}
{% if type == 2 %}
  and ocb.customer_check_status = 3
{% endif %}
{% if type == 3 %}
  and ocb.customer_check_status = 1
{% endif %}
{% if supplier_check_status == 1 %}
  and ocb.supplier_check_status = 1
{% endif %}
{% if supplier_check_status == 2 %}
  and ocb.supplier_check_status = 2
{% endif %}
{% if supplier_check_status == 3 %}
  and ocb.supplier_check_status = 3
{% endif %}
)
select count(1) total_count,sum(order_amount) order_count,sum(settle_amount) ship_count,sum(receive_amount) receive_count,sum(order_price) total_order_price,sum(receive_price) total_receive_price,sum(double_bill_price) total_double_bill_price,
  sum(spec_amount) spec_count
  from tmp

[[query.cust.settle.bill.for.sup.cnt]]
with tem as (
  select o.bill_time,s.id supplier_id,s.name supplier_name,o.supplier_alias_id
  from t_order o
    left join t_supplier s on o.supplier_id=s.id
  where 1=1 and o.bill_time is not null and o.bill_time!=''
    and  exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      )
  {% if settle_time != "" %}
    and o.bill_time = ?settle_time
  {% endif %}
  {% if supplier_id != "" %}
    and o.supplier_id = ?supplier_id
  {% endif %}
    {% if supplier_id != "" %}
      and o.supplier_id = ?supplier_id
    {% endif %}
  group by o.bill_time,s.id,o.supplier_alias_id
)
select
  count(*)  total_count,
  sum(z.checked_amount) total_checked_amount,
  sum(z.customer_abate_amount) total_customer_abate_amount,
  sum(z.settle_amount) total_settle_amount,
  sum(z.pay_amount) total_pay_amount,
  sum(z.payed_amount) total_payed_amount
from (
  select
    COALESCE(o1.checked_amount,0) checked_amount,
    COALESCE(o2.customer_abate_amount,0) customer_abate_amount,
    COALESCE(o1.checked_amount,0)-COALESCE(o2.customer_abate_amount*100,0) settle_amount,
    COALESCE(o4.pay_amount,0)-COALESCE(o6.customer_pay_abate_amount*100,0) pay_amount,
    COALESCE(o5.payed_amount,0)-COALESCE(o7.customer_payed_abate_amount*100,0) payed_amount
  from tem t
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,sum(o.sale_to_customer_price * o.receive_amount) checked_amount
    from t_order o
    where  exists (
       select * from t_customer cs
       inner join (
          select * from t_account_child_customer where account_id = ?account_id
       )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
       where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
    ) and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,o.supplier_alias_id
  ) o1 on o1.bill_time=t.bill_time and o1.supplier_id=t.supplier_id and o1.supplier_alias_id = t.supplier_alias_id
  left join (
    select osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id,sum(osb.customer_abate_quota) customer_abate_amount
    from t_order_settle_bill osb
    where type=1 and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and osb.customer_id = cs.id
      ) and osb.settle_bill_time in (select bill_time from tem)
    group by osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id
  ) o2 on o2.settle_bill_time=t.bill_time and o2.supplier_id=t.supplier_id and o2.supplier_alias_id=t.supplier_alias_id
  left join (
    select osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id,sum(osb.customer_abate_quota) customer_pay_abate_amount
    from t_order_settle_bill osb
      LEFT JOIN (
        select max(a.customer_settle_status) customer_settle_status,a.bill_time,a.supplier_id,a.supplier_alias_id,a.customer_id
        from t_order a group by a.bill_time,a.supplier_id,a.supplier_alias_id,a.customer_id
      ) o on o.bill_time =osb.settle_bill_time and o.supplier_id = osb.supplier_id and o.supplier_alias_id = osb.supplier_alias_id and o.customer_id = osb.customer_id
    where osb.type=1 and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and osb.customer_id = cs.id
      ) and o.customer_settle_status = 2
    group by osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id
  ) o6 on o6.settle_bill_time=t.bill_time and o6.supplier_id=t.supplier_id and o6.supplier_alias_id=t.supplier_alias_id
  left join (
    select osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id,sum(osb.customer_abate_quota) customer_payed_abate_amount
      from t_order_settle_bill osb
        LEFT JOIN (
          select max(a.customer_settle_status) customer_settle_status,a.bill_time,a.supplier_id,a.supplier_alias_id,a.customer_id
          from t_order a group by a.bill_time,a.supplier_id,a.customer_id,a.supplier_alias_id
        ) o on o.bill_time =osb.settle_bill_time and o.supplier_id = osb.supplier_id and o.supplier_alias_id = osb.supplier_alias_id and o.customer_id = osb.customer_id
      where osb.type=1 and exists (
           select * from t_customer cs
           inner join (
              select * from t_account_child_customer where account_id = ?account_id
           )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                    or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
           where cs.leaf = 1 and cs.status = 1 and osb.customer_id = cs.id
        ) and (o.customer_settle_status = 1 or o.customer_settle_status = 3)
      group by osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id
  ) o7 on o7.settle_bill_time=t.bill_time and o7.supplier_id=t.supplier_id and o7.supplier_alias_id=t.supplier_alias_id
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,sum(o.sale_to_customer_price * o.receive_amount) pay_amount
    from t_order o
    where o.customer_settle_status=2 and exists (
       select * from t_customer cs
       inner join (
          select * from t_account_child_customer where account_id = ?account_id
       )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
       where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
    ) and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,o.supplier_alias_id
  ) o4 on o4.bill_time=t.bill_time and o4.supplier_id=t.supplier_id and o4.supplier_alias_id=t.supplier_alias_id
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,sum(o.sale_to_customer_price * o.receive_amount) payed_amount
    from t_order o
    where (o.customer_settle_status=3 or o.customer_settle_status=1)
      and  exists (
           select * from t_customer cs
           inner join (
              select * from t_account_child_customer where account_id = ?account_id
           )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                    or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
           where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
        ) and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,o.supplier_alias_id
  ) o5 on o5.bill_time=t.bill_time and o5.supplier_id=t.supplier_id and o5.supplier_alias_id=t.supplier_alias_id
) z

[[query.cust.settle.bill.for.sup.list]]
with tem as (
  select o.bill_time,s.id supplier_id,sa.id supplier_alias_id,case when sa.id = '0' then s.name else sa.supplier_alias_name end supplier_name
  from t_order o
    left join t_supplier s on o.supplier_id=s.id
     left join (SELECT  a.id,a.supplier_alias_name,a.supplier_id,a.status from t_supplier_alias a  UNION
                      SELECT '0','','',1) sa on o.supplier_alias_id=sa.id
  where 1=1 and o.bill_time is not null and o.bill_time!=''
    and exists (
     select * from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
  )
  {% if settle_time != "" %}
    and o.bill_time = ?settle_time
  {% endif %}
  {% if supplier_id != "" %}
    and o.supplier_id = ?supplier_id
  {% endif %}
   {% if supplier_alias_id != "" %}
      and o.supplier_alias_id = ?supplier_alias_id
    {% endif %}
  group by o.bill_time,s.id,sa.id,sa.supplier_alias_name
)
select
  ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
  t.bill_time settle_bill_time,
  t.supplier_id,
  t.supplier_alias_id,
  t.supplier_name,
  COALESCE(o1.checked_amount,0) checked_amount,
  COALESCE(o2.customer_abate_amount,0) customer_abate_amount,
  COALESCE(o1.checked_amount,0)-COALESCE(o2.customer_abate_amount*100,0) settle_amount,
  COALESCE(o4.pay_amount,0)-COALESCE(o6.customer_pay_abate_amount*100,0) pay_amount,
  COALESCE(o5.payed_amount,0)-COALESCE(o7.customer_payed_abate_amount*100,0) payed_amount
from tem t
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,sum(o.sale_to_customer_price * o.receive_amount) checked_amount
  from t_order o
  where exists (
     select * from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
  ) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,o.supplier_alias_id
) o1 on o1.bill_time=t.bill_time and o1.supplier_id=t.supplier_id and o1.supplier_alias_id=t.supplier_alias_id
left join (
  select osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id,sum(osb.customer_abate_quota) customer_abate_amount
  from t_order_settle_bill osb
  where osb.type=1 and exists (
       select * from t_customer cs
       inner join (
          select * from t_account_child_customer where account_id = ?account_id
       )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
       where cs.leaf = 1 and cs.status = 1 and osb.customer_id = cs.id
    ) and osb.settle_bill_time in (select bill_time from tem)
  group by osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id
) o2 on o2.settle_bill_time=t.bill_time and o2.supplier_id=t.supplier_id and o2.supplier_alias_id=t.supplier_alias_id
left join (
  select osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id,sum(osb.customer_abate_quota) customer_pay_abate_amount
  from t_order_settle_bill osb
    LEFT JOIN (
      select max(a.customer_settle_status) customer_settle_status,a.bill_time,a.supplier_id,a.supplier_alias_id,a.customer_id
      from t_order a group by a.bill_time,a.supplier_id,a.supplier_alias_id,a.customer_id
    ) o on o.bill_time =osb.settle_bill_time and o.supplier_id = osb.supplier_id and o.supplier_alias_id = osb.supplier_alias_id and o.customer_id = osb.customer_id
  where osb.type=1 and  exists (
        select * from t_customer cs
        inner join (
           select * from t_account_child_customer where account_id = ?account_id
        )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                 or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
        where cs.leaf = 1 and cs.status = 1 and osb.customer_id = cs.id
     ) and o.customer_settle_status = 2
  group by osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id
) o6 on o6.settle_bill_time=t.bill_time and o6.supplier_id=t.supplier_id and o6.supplier_alias_id=t.supplier_alias_id
left join (
  select osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id,sum(osb.customer_abate_quota) customer_payed_abate_amount
    from t_order_settle_bill osb
      LEFT JOIN (
        select max(a.customer_settle_status) customer_settle_status,a.bill_time,a.supplier_id,a.supplier_alias_id,a.customer_id
        from t_order a group by a.bill_time,a.supplier_id,a.supplier_alias_id,a.customer_id
      ) o on o.bill_time =osb.settle_bill_time and o.supplier_id = osb.supplier_id and o.supplier_alias_id = osb.supplier_alias_id and o.customer_id = osb.customer_id
    where osb.type=1 and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and osb.customer_id = cs.id
      ) and (o.customer_settle_status = 1 or o.customer_settle_status = 3)
    group by osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id
) o7 on o7.settle_bill_time=t.bill_time and o7.supplier_id=t.supplier_id and o7.supplier_alias_id=t.supplier_alias_id
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,sum(o.sale_to_customer_price * o.receive_amount) pay_amount
  from t_order o
  where o.customer_settle_status=2 and exists (
     select * from t_customer cs
     inner join (
        select * from t_account_child_customer where account_id = ?account_id
     )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
              or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
     where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
  ) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,o.supplier_alias_id
) o4 on o4.bill_time=t.bill_time and o4.supplier_id=t.supplier_id and o4.supplier_alias_id=t.supplier_alias_id
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,sum(o.sale_to_customer_price * o.receive_amount) payed_amount
  from t_order o
  where (o.customer_settle_status=3 or o.customer_settle_status=1)
    and exists (
        select * from t_customer cs
        inner join (
           select * from t_account_child_customer where account_id = ?account_id
        )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                 or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
        where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
     ) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,o.supplier_alias_id
) o5 on o5.bill_time=t.bill_time and o5.supplier_id=t.supplier_id and o5.supplier_alias_id=t.supplier_alias_id
limit ?page_size offset (?page_num - 1) * ?page_size

[[query.cust.settle.bill.for.cust.cnt]]
with tem as (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,c.id customer_id,c.name customer_name
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where 1=1 and o.bill_time=?settle_time and o.supplier_id=?supplier_id and o.supplier_alias_id=?supplier_alias_id
    and exists (
       select * from t_customer cs
       inner join (
          select * from t_account_child_customer where account_id = ?account_id
       )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
       where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
    )
  {% if customer_id != "" %}
    and o.customer_id = ?customer_id
  {% endif %}
  group by o.bill_time,o.supplier_id,o.supplier_alias_id,c.id
)
select
  count(a.*) total_count,
  sum(a.checked_amount) total_checked_amount,
  sum(a.settle_amount) total_settle_amount,
  sum(a.pay_amount) total_pay_amount,
  sum(a.payed_amount) total_payed_amount
from
(
  select
    COALESCE(o1.checked_amount,0) checked_amount,
    COALESCE(o1.checked_amount,0)-COALESCE(o2.customer_abate_amount*100,0) settle_amount,
    case when COALESCE(o7.pay_count,0)!=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)=0 then COALESCE(o4.pay_amount,0)-COALESCE(o2.customer_abate_amount*100,0)
      else 0 end pay_amount,
    case when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)!=0 then COALESCE(o5.payed_amount,0)-COALESCE(o2.customer_abate_amount*100,0)
      when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)!=0 and COALESCE(o8.payed_count,0)=0 then COALESCE(o5.payed_amount,0)-COALESCE(o2.customer_abate_amount*100,0)
      else 0 end  payed_amount
  from tem t
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) checked_amount
    from t_order o
    where exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      ) and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
  ) o1 on o1.bill_time=t.bill_time and o1.supplier_id=t.supplier_id and o1.supplier_alias_id=t.supplier_alias_id and o1.customer_id=t.customer_id
  left join (
    select osb.id settle_id,osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id,osb.customer_id,osb.customer_abate_quota customer_abate_amount
    from t_order_settle_bill osb
    where osb.type=1 and exists (
        select * from t_customer cs
        inner join (
           select * from t_account_child_customer where account_id = ?account_id
        )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                 or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
        where cs.leaf = 1 and cs.status = 1 and osb.customer_id = cs.id
     ) and osb.settle_bill_time in (select bill_time from tem)
  ) o2 on o2.settle_bill_time=t.bill_time and o2.supplier_id=t.supplier_id and o2.supplier_alias_id=t.supplier_alias_id and o2.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) pay_amount
    from t_order o
    where o.customer_settle_status=2 and exists (
          select * from t_customer cs
          inner join (
             select * from t_account_child_customer where account_id = ?account_id
          )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                   or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
          where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
       ) and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
  ) o4 on o4.bill_time=t.bill_time and o4.supplier_id=t.supplier_id and o4.supplier_alias_id=t.supplier_alias_id and o4.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) payed_amount
    from t_order o
    where (o.customer_settle_status=3 or o.customer_settle_status=1)
      and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      ) and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
  ) o5 on o5.bill_time=t.bill_time and o5.supplier_id=t.supplier_id and o5.supplier_alias_id=t.supplier_alias_id and o5.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,count(*) received_count
    from t_order o
    where o.customer_settle_status=1
      and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      ) and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
  ) o6 on o6.bill_time=t.bill_time and o6.supplier_id=t.supplier_id and o6.supplier_alias_id=t.supplier_alias_id and o6.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,count(*) pay_count
    from t_order o
    where o.customer_settle_status=2
      and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      ) and o.bill_time in (select bill_time from tem)
    group by bill_time,supplier_id,supplier_alias_id,customer_id
  ) o7 on o7.bill_time=t.bill_time and o7.supplier_id=t.supplier_id and o7.supplier_alias_id=t.supplier_alias_id and o7.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,count(*) payed_count
    from t_order o
    where o.customer_settle_status=3
      and exists (
           select * from t_customer cs
           inner join (
              select * from t_account_child_customer where account_id = ?account_id
           )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                    or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
           where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
        ) and o.bill_time in (select bill_time from tem)
    group by bill_time,supplier_id,supplier_alias_id,customer_id
  ) o8 on o8.bill_time=t.bill_time and o8.supplier_id=t.supplier_id and o8.supplier_alias_id=t.supplier_alias_id and o8.customer_id=t.customer_id
) a

[[query.cust.settle.bill.for.cust.list]]
with tem as (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,c.id customer_id,c.name customer_name
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where 1=1 and o.bill_time=?settle_time and o.supplier_id=?supplier_id and o.supplier_alias_id=?supplier_alias_id
    and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      )
  {% if customer_id != "" %}
    and o.customer_id = ?customer_id
  {% endif %}
  group by o.bill_time,o.supplier_id,o.supplier_alias_id,c.id
)
select
  ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
  t.bill_time settle_bill_time,
  t.customer_id,
  t.customer_name,
  o2.settle_id,
  COALESCE(o1.checked_amount,0) checked_amount,
  COALESCE(o2.customer_abate_amount,0) customer_abate_amount,
  COALESCE(o1.checked_amount,0)-COALESCE(o2.customer_abate_amount*100,0) settle_amount,
  case when COALESCE(o7.pay_count,0)!=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)=0 then COALESCE(o4.pay_amount,0)-COALESCE(o2.customer_abate_amount*100,0)
    else 0 end pay_amount,
  case when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)!=0 then COALESCE(o5.payed_amount,0)-COALESCE(o2.customer_abate_amount*100,0)
    when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)!=0 and COALESCE(o8.payed_count,0)=0 then COALESCE(o5.payed_amount,0)-COALESCE(o2.customer_abate_amount*100,0)
    else 0 end  payed_amount,
  case when COALESCE(o7.pay_count,0)!=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)=0 then 2
    when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)!=0 then 3
    when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)!=0 and COALESCE(o8.payed_count,0)=0 then 1
    else 0 end settle_status,
  case when COALESCE(o7.pay_count,0)!=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)=0 then '客户未付款'
    when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)!=0 then '中心未收款'
    when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)!=0 and COALESCE(o8.payed_count,0)=0 then '中心已收款'
    else '未知' end settle_status_desc
from tem t
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) checked_amount
  from t_order o
  where exists (
       select * from t_customer cs
       inner join (
          select * from t_account_child_customer where account_id = ?account_id
       )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
       where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
    ) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
) o1 on o1.bill_time=t.bill_time and o1.supplier_id=t.supplier_id and o1.supplier_alias_id=t.supplier_alias_id and o1.customer_id=t.customer_id
left join (
  select osb.id settle_id,osb.settle_bill_time,osb.supplier_id,osb.supplier_alias_id,osb.customer_id,osb.customer_abate_quota customer_abate_amount
  from t_order_settle_bill osb
  where osb.type=1 and exists (
        select * from t_customer cs
        inner join (
           select * from t_account_child_customer where account_id = ?account_id
        )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                 or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
        where cs.leaf = 1 and cs.status = 1 and osb.customer_id = cs.id
     ) and osb.settle_bill_time in (select bill_time from tem)
) o2 on o2.settle_bill_time=t.bill_time and o2.supplier_id=t.supplier_id and o2.supplier_alias_id=t.supplier_alias_id and o2.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) pay_amount
  from t_order o
  where o.customer_settle_status=2 and exists (
      select * from t_customer cs
      inner join (
         select * from t_account_child_customer where account_id = ?account_id
      )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
               or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
      where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
   ) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
) o4 on o4.bill_time=t.bill_time and o4.supplier_id=t.supplier_id and o4.supplier_alias_id=t.supplier_alias_id and o4.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) payed_amount
  from t_order o
  where (o.customer_settle_status=3 or o.customer_settle_status=1)
    and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      ) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
) o5 on o5.bill_time=t.bill_time and o5.supplier_id=t.supplier_id and o5.supplier_alias_id=t.supplier_alias_id and o5.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,count(*) received_count
  from t_order o
  where o.customer_settle_status=1
    and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      ) and o.bill_time in (select bill_time from tem)
  group by bill_time,supplier_id,supplier_alias_id,customer_id
) o6 on o6.bill_time=t.bill_time and o6.supplier_id=t.supplier_id and o6.supplier_alias_id=t.supplier_alias_id and o6.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,count(*) pay_count
  from t_order o
  where o.customer_settle_status=2
    and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      ) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
) o7 on o7.bill_time=t.bill_time and o7.supplier_id=t.supplier_id and o7.supplier_alias_id=t.supplier_alias_id and o7.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id,count(*) payed_count
  from t_order o
  where o.customer_settle_status=3
    and exists (
         select * from t_customer cs
         inner join (
            select * from t_account_child_customer where account_id = ?account_id
         )qy on cs.tree_ids like '%,' || qy.customer_id ||',%' or cs.tree_ids like '%,'|| qy.customer_id
                  or cs.tree_ids like qy.customer_id||',%' or cs.tree_ids = qy.customer_id or cs.id = qy.customer_id
         where cs.leaf = 1 and cs.status = 1 and o.customer_id = cs.id
      ) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,o.supplier_alias_id,o.customer_id
) o8 on o8.bill_time=t.bill_time and o8.supplier_id=t.supplier_id and o8.supplier_alias_id=t.supplier_alias_id and o8.customer_id=t.customer_id
limit ?page_size offset (?page_num - 1) * ?page_size

[[query.cust.settle.bill.detail.cnt]]
with tem as (
  select
    *
  from t_order o
    left join t_goods g on o.goods_id=g.id
  where bill_time=?settle_bill_time and supplier_id=?supplier_id and customer_id =?customer_id and supplier_alias_id=?supplier_alias_id
  {% if !order_time_start.IsZero %}
    and o.order_time >= ?order_time_start
  {% endif %}
  {% if !order_time_end.IsZero %}
    and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
  {% endif %}
  {% if !ship_time_start.IsZero %}
    and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
  {% endif %}
  {% if !ship_time_end.IsZero %}
    and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
  {% endif %}
  {% if !finish_time_start.IsZero %}
    and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
  {% endif %}
  {% if !finish_time_end.IsZero %}
    and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
  {% endif %}
  {% if keyword!="" %}
    and ( o.goods_name ilike '%'|| ?keyword ||'%' or CnFirstChar(o.goods_name) ilike '%'|| ?keyword ||'%' or o.order_no ilike '%'|| ?keyword ||'%'  )
  {% endif %}
)
select
  z.total_count,
  COALESCE(a.checked_amount,0) total_checked_amount
from (
  select count(*) total_count from tem
) z,(
  select sum(sale_to_customer_price * receive_amount) checked_amount from tem
) a

[[query.cust.settle.bill.detail.list]]
select
  ROW_NUMBER () OVER (ORDER BY cast(o.id as integer) desc) AS row_num,
  o.id,
  o.order_no,
  o.order_sub_no,
  g.name goods_name,
  o.receive_amount checked_count,
  o.sale_to_customer_price,
  o.receive_amount * o.sale_to_customer_price checked_amount,
  o.order_time,
  o.ship_time,
  o.finish_time,
  o.customer_settle_status settle_status,
  case o.customer_settle_status when 1 then '中心已收款'
    when 2 then '客户未付款'
    when 3 then '中心未收款' end as settle_status_desc,
  o.unit_id
from t_order o
  left join t_goods g on o.goods_id=g.id
where bill_time=?settle_bill_time and supplier_id=?supplier_id and customer_id =?customer_id and supplier_alias_id=?supplier_alias_id
{% if !order_time_start.IsZero %}
  and o.order_time >= ?order_time_start
{% endif %}
{% if !order_time_end.IsZero %}
  and o.order_time <to_date(?order_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !ship_time_start.IsZero %}
  and o.ship_time >=to_date(?ship_time_start,'YYYY-MM-DD')
{% endif %}
{% if !ship_time_end.IsZero %}
  and o.ship_time <to_date(?ship_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if !finish_time_start.IsZero %}
  and o.finish_time >=to_date(?finish_time_start,'YYYY-MM-DD')
{% endif %}
{% if !finish_time_end.IsZero %}
  and o.finish_time <to_date(?finish_time_end,'YYYY-MM-DD')+1
{% endif %}
{% if keyword!="" %}
  and ( o.goods_name ilike '%'|| ?keyword ||'%'  or CnFirstChar(o.goods_name) ilike '%'|| ?keyword ||'%'  or o.order_no ilike '%'|| ?keyword ||'%'  )
{% endif %}
limit ?page_size offset (?page_num - 1) * ?page_size

[[query.admin.settle.bill.for.jt.cnt]]
select count(*) cnt
from (
  select o.bill_time,c2.id parent_customer_id,c2.name parent_customer_name
  from t_order o
    left join t_customer c on o.customer_id=c.id
    left join t_customer c2 on c2.id=c.parent_customer_id
  where 1=1 and o.bill_time!='' and o.bill_time is not null
  {% if settle_bill_time != "" %}
    and o.bill_time = ?settle_bill_time
  {% endif %}
  {% if parent_customer_id != "" %}
     and c.parent_customer_id = ?parent_customer_id
  {% endif %}
  group by o.bill_time,c2.id
)z

[[query.admin.settle.bill.for.jt.list]]
with tem as (
  select o.bill_time,c2.id parent_customer_id,c2.name parent_customer_name
  from t_order o
    left join t_customer c on o.customer_id=c.id
    left join t_customer c2 on c2.id=c.parent_customer_id
  where 1=1 and o.bill_time!='' and o.bill_time is not null
  {% if settle_bill_time != "" %}
    and o.bill_time = ?settle_bill_time
  {% endif %}
  {% if parent_customer_id != "" %}
     and c.parent_customer_id = ?parent_customer_id
  {% endif %}
  group by o.bill_time,c2.id
)
select
  ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
  t.bill_time settle_bill_time,
  t.parent_customer_id,
  t.parent_customer_name,
  COALESCE(o1.checked_amount,0) checked_amount,
  COALESCE(o2.customer_abate_amount,0) customer_abate_amount,
  COALESCE(o1.checked_amount,0)-COALESCE(o2.customer_abate_amount*100,0) settle_amount,
  COALESCE(o4.receive_amount,0)-COALESCE(o6.admin_receive_abate_amount*100,0) receive_amount,
  COALESCE(o5.received_amount,0)-COALESCE(o7.admin_received_abate_amount*100,0) received_amount
from tem t
left join (
  select o.bill_time,c.parent_customer_id,sum(o.sale_to_customer_price * o.receive_amount) checked_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where o.bill_time in (select bill_time from tem)
  group by o.bill_time,c.parent_customer_id
) o1 on o1.bill_time=t.bill_time and o1.parent_customer_id=t.parent_customer_id
left join (
  select a.settle_bill_time,c.parent_customer_id,sum(a.customer_abate_quota) customer_abate_amount
  from t_order_settle_bill a
    left join t_customer c on a.customer_id = c.id
  where a.type=1 and a.settle_bill_time in (select bill_time from tem)
  group by a.settle_bill_time,c.parent_customer_id
) o2 on o2.settle_bill_time=t.bill_time and o2.parent_customer_id=t.parent_customer_id
left join (
  select a.settle_bill_time,c.parent_customer_id,sum(a.customer_abate_quota) admin_receive_abate_amount
  from t_order_settle_bill a
    left join t_customer c on a.customer_id = c.id
    left join (
      select max(customer_settle_status) customer_settle_status,bill_time,supplier_id,customer_id
      from t_order group by bill_time,supplier_id,customer_id
    ) o on o.bill_time = a.settle_bill_time and o.supplier_id = a.supplier_id and o.customer_id = a.customer_id
  where a.type=1 and a.settle_bill_time in (select bill_time from tem) and (o.customer_settle_status=2 or o.customer_settle_status=3)
  group by a.settle_bill_time,c.parent_customer_id
) o6 on o6.settle_bill_time=t.bill_time and o6.parent_customer_id=t.parent_customer_id
left join (
  select a.settle_bill_time,c.parent_customer_id,sum(a.customer_abate_quota) admin_received_abate_amount
  from t_order_settle_bill a
    left join t_customer c on a.customer_id = c.id
    left join (
      select max(customer_settle_status) customer_settle_status,bill_time,supplier_id,customer_id
      from t_order group by bill_time,supplier_id,customer_id
    ) o on o.bill_time = a.settle_bill_time and o.supplier_id = a.supplier_id and o.customer_id = a.customer_id
  where a.type=1 and a.settle_bill_time in (select bill_time from tem) and o.customer_settle_status=1
  group by a.settle_bill_time,c.parent_customer_id
) o7 on o7.settle_bill_time=t.bill_time and o7.parent_customer_id=t.parent_customer_id
left join (
  select o.bill_time,c.parent_customer_id,sum(o.sale_to_customer_price * o.receive_amount) receive_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where (o.customer_settle_status=2 or o.customer_settle_status=3) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,c.parent_customer_id
) o4 on o4.bill_time=t.bill_time and o4.parent_customer_id=t.parent_customer_id
left join (
  select o.bill_time,c.parent_customer_id,sum(o.sale_to_customer_price * o.receive_amount) received_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where o.customer_settle_status=1 and o.bill_time in (select bill_time from tem)
  group by o.bill_time,c.parent_customer_id
) o5 on o5.bill_time=t.bill_time and o5.parent_customer_id=t.parent_customer_id
limit ?page_size offset (?page_num - 1) * ?page_size

[[query.admin.settle.bill.for.sup.cnt]]
select count(*) cnt from (
  select o.bill_time,s.id supplier_id,s.name supplier_name,c2.id parent_customer_id,c2.name parent_customer_name
  from t_order o
    left join t_customer c on o.customer_id=c.id
    left join t_customer c2 on c2.id=c.parent_customer_id
    left join t_supplier s on s.id=o.supplier_id
  where 1=1 and o.bill_time=?settle_bill_time and c2.id=?parent_customer_id
  {% if supplier_id != "" %}
    and o.supplier_id = ?supplier_id
  {% endif %}
  group by o.bill_time,s.id,c2.id
) z

[[query.admin.settle.bill.for.sup.list]]
with tem as (
  select o.bill_time,s.id supplier_id,s.name supplier_name,c2.id parent_customer_id,c2.name parent_customer_name
  from t_order o
    left join t_customer c on o.customer_id=c.id
    left join t_customer c2 on c2.id=c.parent_customer_id
    left join t_supplier s on s.id=o.supplier_id
  where 1=1 and o.bill_time=?settle_bill_time and c2.id=?parent_customer_id
  {% if supplier_id != "" %}
    and o.supplier_id = ?supplier_id
  {% endif %}
  group by o.bill_time,s.id,c2.id
)
select
  ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
  t.bill_time settle_bill_time,
  t.supplier_id,
  t.supplier_name,
  t.parent_customer_name,
  COALESCE(o1.checked_amount,0) checked_amount,
  COALESCE(o2.customer_abate_amount,0) customer_abate_amount,
  COALESCE(o1.checked_amount,0)-COALESCE(o2.customer_abate_amount*100,0) settle_amount,
  COALESCE(o4.receive_amount,0)-COALESCE(o6.admin_receive_abate_amount*100,0) receive_amount,
  COALESCE(o5.received_amount,0)-COALESCE(o7.admin_received_abate_amount*100,0) received_amount
from tem t
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,sum(o.sale_to_customer_price * o.receive_amount) checked_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id
) o1 on o1.bill_time=t.bill_time and o1.supplier_id=t.supplier_id and o1.parent_customer_id=t.parent_customer_id
left join (
  select a.settle_bill_time,a.supplier_id,c.parent_customer_id,sum(a.customer_abate_quota) customer_abate_amount
  from t_order_settle_bill a
    left join t_customer c on a.customer_id = c.id
  where a.type=1 and a.settle_bill_time in (select bill_time from tem)
  group by a.settle_bill_time,a.supplier_id,c.parent_customer_id
) o2 on o2.settle_bill_time=t.bill_time and o2.supplier_id=t.supplier_id and o2.parent_customer_id=t.parent_customer_id
left join (
  select a.settle_bill_time,a.supplier_id,c.parent_customer_id,sum(a.customer_abate_quota) admin_receive_abate_amount
  from t_order_settle_bill a
    left join t_customer c on a.customer_id = c.id
    left join (
      select max(customer_settle_status) customer_settle_status,bill_time,supplier_id,customer_id
      from t_order group by bill_time,supplier_id,customer_id
    ) o on o.bill_time = a.settle_bill_time and o.supplier_id = a.supplier_id and o.customer_id = a.customer_id
  where a.type=1 and a.settle_bill_time in (select bill_time from tem) and (o.customer_settle_status=2 or o.customer_settle_status=3)
  group by a.settle_bill_time,a.supplier_id,c.parent_customer_id
) o6 on o6.settle_bill_time=t.bill_time and o6.supplier_id=t.supplier_id and o6.parent_customer_id=t.parent_customer_id
left join (
  select a.settle_bill_time,a.supplier_id,c.parent_customer_id,sum(a.customer_abate_quota) admin_received_abate_amount
  from t_order_settle_bill a
    left join t_customer c on a.customer_id = c.id
    left join (
      select max(customer_settle_status) customer_settle_status,bill_time,supplier_id,customer_id
      from t_order group by bill_time,supplier_id,customer_id
    ) o on o.bill_time = a.settle_bill_time and o.supplier_id = a.supplier_id and o.customer_id = a.customer_id
  where a.type=1 and a.settle_bill_time in (select bill_time from tem) and o.customer_settle_status=1
  group by a.settle_bill_time,a.supplier_id,c.parent_customer_id
) o7 on o7.settle_bill_time=t.bill_time and o7.supplier_id=t.supplier_id and o7.parent_customer_id=t.parent_customer_id
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,sum(o.sale_to_customer_price * o.receive_amount) receive_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where (o.customer_settle_status=2 or o.customer_settle_status=3) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id
) o4 on o4.bill_time=t.bill_time and o4.supplier_id=t.supplier_id and o4.parent_customer_id=t.parent_customer_id
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,sum(o.sale_to_customer_price * o.receive_amount) received_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where o.customer_settle_status=1
    and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id
) o5 on o5.bill_time=t.bill_time and o5.supplier_id=t.supplier_id and o5.parent_customer_id=t.parent_customer_id
limit ?page_size offset (?page_num - 1) * ?page_size

[[query.admin.settle.bill.for.cust.cnt]]
with tem as (
  select o.bill_time,s.id supplier_id,s.name supplier_name,c2.id parent_customer_id,c2.name parent_customer_name,c.id customer_id,c.name customer_name
  from t_order o
    left join t_customer c on o.customer_id=c.id
    left join t_customer c2 on c2.id=c.parent_customer_id
    left join t_supplier s on s.id=o.supplier_id
  where 1=1 and o.bill_time=?settle_bill_time and c2.id=?parent_customer_id
    and o.supplier_id = ?supplier_id
    {% if customer_id != "" %}
      and o.customer_id = ?customer_id
    {% endif %}
  group by o.bill_time,s.id,c2.id,c.id
)
select
  count(z.*) total_count,
  sum(z.checked_amount) total_checked_amount,
  sum(z.customer_abate_amount) total_customer_abate_amount,
  sum(z.settle_amount) total_settle_amount
from (
  select
    COALESCE(o1.checked_amount,0) checked_amount,
    COALESCE(o2.customer_abate_amount,0) customer_abate_amount,
    COALESCE(o1.checked_amount,0)-COALESCE(o2.customer_abate_amount*100,0) settle_amount,
    case when COALESCE(o7.pay_count,0)!=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)=0 then COALESCE(o4.receive_amount,0) - COALESCE(o2.customer_abate_amount*100,0)
      when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)!=0 then COALESCE(o4.receive_amount,0) - COALESCE(o2.customer_abate_amount*100,0)
      else 0 end receive_amount,
    case when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)!=0 and COALESCE(o8.payed_count,0)=0 then COALESCE(o5.received_amount,0) - COALESCE(o2.customer_abate_amount*100,0)
      else 0 end received_amount,
    case when COALESCE(o7.pay_count,0)!=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)=0 then '客户未付款'
      when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)!=0 then '中心未收款'
      when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)!=0 and COALESCE(o8.payed_count,0)=0 then '中心已收款'
      else '未知' end settle_status_desc
  from tem t
  left join (
    select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) checked_amount
    from t_order o
      left join t_customer c on o.customer_id=c.id
    where o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
  ) o1 on o1.bill_time=t.bill_time and o1.supplier_id=t.supplier_id and o1.parent_customer_id=t.parent_customer_id and o1.customer_id=t.customer_id
  left join (
    select a.settle_bill_time,a.supplier_id,c.parent_customer_id,a.customer_id,sum(a.customer_abate_quota) customer_abate_amount
    from t_order_settle_bill a
      left join t_customer c on a.customer_id = c.id
    where a.type=1 and a.settle_bill_time in (select bill_time from tem)
    group by a.settle_bill_time,a.supplier_id,c.parent_customer_id,a.customer_id
  ) o2 on o2.settle_bill_time=t.bill_time and o2.supplier_id=t.supplier_id and o2.parent_customer_id=t.parent_customer_id and o2.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) receive_amount
    from t_order o
      left join t_customer c on o.customer_id=c.id
    where (o.customer_settle_status=2 or o.customer_settle_status=3) and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
  ) o4 on o4.bill_time=t.bill_time and o4.supplier_id=t.supplier_id and o4.parent_customer_id=t.parent_customer_id and o4.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) received_amount
    from t_order o
      left join t_customer c on o.customer_id=c.id
    where customer_settle_status=1
      and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
  ) o5 on o5.bill_time=t.bill_time and o5.supplier_id=t.supplier_id and o5.parent_customer_id=t.parent_customer_id and o5.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,count(*) received_count
    from t_order o
      left join t_customer c on o.customer_id=c.id
    where o.customer_settle_status=1
      and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
  ) o6 on o6.bill_time=t.bill_time and o6.supplier_id=t.supplier_id and o6.parent_customer_id=t.parent_customer_id and o6.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,count(*) pay_count
    from t_order o
      left join t_customer c on o.customer_id=c.id
    where o.customer_settle_status=2
      and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
  ) o7 on o7.bill_time=t.bill_time and o7.supplier_id=t.supplier_id and o7.parent_customer_id=t.parent_customer_id and o7.customer_id=t.customer_id
  left join (
    select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,count(*) payed_count
    from t_order o
      left join t_customer c on o.customer_id=c.id
    where o.customer_settle_status=3
      and o.bill_time in (select bill_time from tem)
    group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
  ) o8 on o8.bill_time=t.bill_time and o8.supplier_id=t.supplier_id and o8.parent_customer_id=t.parent_customer_id and o8.customer_id=t.customer_id
) z

[[query.admin.settle.bill.for.cust.list]]
with tem as (
  select o.bill_time,s.id supplier_id,s.name supplier_name,c2.id parent_customer_id,c2.name parent_customer_name,c.id customer_id,c.name customer_name
  from t_order o
    left join t_customer c on o.customer_id=c.id
    left join t_customer c2 on c2.id=c.parent_customer_id
    left join t_supplier s on s.id=o.supplier_id
  where 1=1 and o.bill_time=?settle_bill_time and c2.id=?parent_customer_id
    and o.supplier_id = ?supplier_id
    {% if customer_id != "" %}
      and o.customer_id = ?customer_id
    {% endif %}
  group by o.bill_time,s.id,c2.id,c.id
)
select
  ROW_NUMBER () OVER (ORDER BY t.bill_time desc) AS row_num,
  t.bill_time settle_bill_time,
  t.supplier_id,
  t.supplier_name,
  t.parent_customer_name,
  t.customer_id,
  t.customer_name,
  o2.id settle_id,
  COALESCE(o1.checked_amount,0) checked_amount,
  COALESCE(o2.customer_abate_amount,0) customer_abate_amount,
  COALESCE(o1.checked_amount,0)-COALESCE(o2.customer_abate_amount*100,0) settle_amount,
  case when COALESCE(o7.pay_count,0)!=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)=0 then COALESCE(o4.receive_amount,0) - COALESCE(o2.customer_abate_amount*100,0)
    when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)!=0 then COALESCE(o4.receive_amount,0) - COALESCE(o2.customer_abate_amount*100,0)
    else 0 end receive_amount,
  case when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)!=0 and COALESCE(o8.payed_count,0)=0 then COALESCE(o5.received_amount,0) - COALESCE(o2.customer_abate_amount*100,0)
    else 0 end received_amount,
  case when COALESCE(o7.pay_count,0)!=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)=0 then '客户未付款'
    when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)=0 and COALESCE(o8.payed_count,0)!=0 then '中心未收款'
    when COALESCE(o7.pay_count,0)=0 and COALESCE(o6.received_count,0)!=0 and COALESCE(o8.payed_count,0)=0 then '中心已收款'
    else '未知' end settle_status_desc
from tem t
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) checked_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
) o1 on o1.bill_time=t.bill_time and o1.supplier_id=t.supplier_id and o1.parent_customer_id=t.parent_customer_id and o1.customer_id=t.customer_id
left join (
  select a.id,a.settle_bill_time,a.supplier_id,c.parent_customer_id,a.customer_id,a.customer_abate_quota customer_abate_amount
  from t_order_settle_bill a
    left join t_customer c on a.customer_id = c.id
  where a.type=1 and a.settle_bill_time in (select bill_time from tem)
) o2 on o2.settle_bill_time=t.bill_time and o2.supplier_id=t.supplier_id and o2.parent_customer_id=t.parent_customer_id and o2.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) receive_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where (o.customer_settle_status=2 or o.customer_settle_status=3) and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
) o4 on o4.bill_time=t.bill_time and o4.supplier_id=t.supplier_id and o4.parent_customer_id=t.parent_customer_id and o4.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,sum(o.sale_to_customer_price * o.receive_amount) received_amount
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where customer_settle_status=1
    and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
) o5 on o5.bill_time=t.bill_time and o5.supplier_id=t.supplier_id and o5.parent_customer_id=t.parent_customer_id and o5.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,count(*) received_count
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where o.customer_settle_status=1
    and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
) o6 on o6.bill_time=t.bill_time and o6.supplier_id=t.supplier_id and o6.parent_customer_id=t.parent_customer_id and o6.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,count(*) pay_count
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where o.customer_settle_status=2
    and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
) o7 on o7.bill_time=t.bill_time and o7.supplier_id=t.supplier_id and o7.parent_customer_id=t.parent_customer_id and o7.customer_id=t.customer_id
left join (
  select o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id,count(*) payed_count
  from t_order o
    left join t_customer c on o.customer_id=c.id
  where o.customer_settle_status=3
    and o.bill_time in (select bill_time from tem)
  group by o.bill_time,o.supplier_id,c.parent_customer_id,o.customer_id
) o8 on o8.bill_time=t.bill_time and o8.supplier_id=t.supplier_id and o8.parent_customer_id=t.parent_customer_id and o8.customer_id=t.customer_id
limit ?page_size offset (?page_num - 1) * ?page_size

[[query.supplier.bill.month.by.manage.cnt]]
with tmp as (
SELECT
  t3.bill_time,
  t3.parent_customer_id,
   sum(check_price) check_price,
   sum(customer_quota) customer_quota,
   sum(admin_quota) admin_quota,
   sum(supplier_bill_price) supplier_bill_price,
   sum(ready_pay_price) ready_pay_price,
   sum(finish_price) finish_price
FROM (
  SELECT
  t2.bill_time,
  t2.supplier_id,
  t2.parent_customer_id,
  t2.check_price,
  customer_quota,
  COALESCE(osb1.admin_abate_quota,0) as admin_quota,
  check_price - COALESCE(osb1.admin_abate_quota,0) * 100 as supplier_bill_price,
  CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  ready_pay_price,
  CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  finish_price
FROM (
  SELECT
  t1.bill_time,
  t1.supplier_id,
  c.parent_customer_id,
  sum(check_price) check_price,
  sum(customer_quota) customer_quota,
  sum(ready_pay_price) ready_pay_price,
  sum(finish_price) finish_price
FROM (
  SELECT
  t.*,
  COALESCE(osb.customer_abate_quota,0) customer_quota
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  o.supplier_id,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.buy_from_supplier_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.buy_from_supplier_price,0)) finish_price
FROM t_order o
LEFT JOIN t_order o1 ON o1.supplier_settle_status = 2 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.supplier_settle_status != 2 AND o2.id = o.id
where o.bill_time NOTNULL
GROUP BY o.bill_time ,o.supplier_id,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = t.supplier_id AND osb.type = 1
) t1
INNER JOIN t_customer c on c.parent_customer_id !='0' AND c.id = t1.customer_id
GROUP BY t1.bill_time,t1.supplier_id,c.parent_customer_id
) t2
LEFT JOIN t_order_settle_bill osb1 ON osb1.settle_bill_time= t2.bill_time AND  osb1.supplier_id = t2.supplier_id AND osb1.parent_customer_id=t2.parent_customer_id AND osb1.type = 2
) t3
GROUP BY t3.bill_time,t3.parent_customer_id
)
select count(1) cnt from tmp t
INNER JOIN t_customer c ON c.id = t.parent_customer_id
WHERE 1=1
{% if bill_time != "" %}
   and t.bill_time = ?bill_time
{% endif %}
{% if parent_customer_id!="" %}
  and  t.parent_customer_id = ?parent_customer_id
{% endif %}

[[query.supplier.bill.month.by.manage.list]]
with tmp as (
SELECT
  t3.bill_time,
  t3.parent_customer_id,
   sum(check_price) check_price,
   sum(customer_quota) customer_quota,
   sum(admin_quota) admin_quota,
   sum(supplier_bill_price) supplier_bill_price,
   sum(ready_pay_price) ready_pay_price,
   sum(finish_price) finish_price,
   CASE sum(ready_pay_price) WHEN 0 THEN 1 ELSE 2 END  status
FROM (
  SELECT
  t2.bill_time,
  t2.supplier_id,
  t2.parent_customer_id,
  t2.check_price,
  customer_quota,
  COALESCE(osb1.admin_abate_quota,0) as admin_quota,
  check_price - COALESCE(osb1.admin_abate_quota,0) * 100 as supplier_bill_price,
  CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  ready_pay_price,
  CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  finish_price
FROM (
  SELECT
  t1.bill_time,
  t1.supplier_id,
  c.parent_customer_id,
  sum(check_price) check_price,
  sum(customer_quota) customer_quota,
  sum(ready_pay_price) ready_pay_price,
  sum(finish_price) finish_price
FROM (
  SELECT
  t.*,
  COALESCE(osb.customer_abate_quota,0) customer_quota
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  o.supplier_id,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.buy_from_supplier_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.buy_from_supplier_price,0)) finish_price
FROM t_order o
LEFT JOIN t_order o1 ON o1.supplier_settle_status = 2 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.supplier_settle_status != 2 AND o2.id = o.id
where o.bill_time NOTNULL
GROUP BY o.bill_time ,o.supplier_id,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = t.supplier_id AND osb.type = 1
) t1
INNER JOIN t_customer c on c.parent_customer_id !='0' AND c.id = t1.customer_id
GROUP BY t1.bill_time,t1.supplier_id,c.parent_customer_id
) t2
LEFT JOIN t_order_settle_bill osb1 ON osb1.settle_bill_time= t2.bill_time AND  osb1.supplier_id = t2.supplier_id AND osb1.parent_customer_id=t2.parent_customer_id AND osb1.type = 2
) t3
GROUP BY t3.bill_time,t3.parent_customer_id
)
select t.*,c.name parent_customer_name,
 ROW_NUMBER() over( order by t.bill_time desc,t.parent_customer_id) row_num
 from tmp t
INNER JOIN t_customer c ON c.id = t.parent_customer_id
WHERE 1=1
{% if bill_time != "" %}
   and t.bill_time = ?bill_time
{% endif %}
{% if parent_customer_id!="" %}
  and  t.parent_customer_id = ?parent_customer_id
{% endif %}
order by t.bill_time desc,t.parent_customer_id limit ?page_size offset (?page_num - 1) * ?page_size

[[query.supplier.cus.settle.by.manage.cnt]]
with tmp as(
 SELECT
  t2.bill_time,
  t2.supplier_id,
  t2.parent_customer_id,
  t2.check_price,
  customer_quota,
  COALESCE(osb1.admin_abate_quota,0) as admin_quota,
  check_price - COALESCE(osb1.admin_abate_quota,0) * 100 as supplier_bill_price,
  CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  ready_pay_price,
  CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  finish_price
FROM (
  SELECT
  t1.bill_time,
  t1.supplier_id,
  c.parent_customer_id,
  sum(check_price) check_price,
  sum(customer_quota) customer_quota,
  sum(ready_pay_price) ready_pay_price,
  sum(finish_price) finish_price
FROM (
  SELECT
  t.*,
  COALESCE(osb.customer_abate_quota,0) customer_quota
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  o.supplier_id,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.buy_from_supplier_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.buy_from_supplier_price,0)) finish_price
FROM t_order o
LEFT JOIN t_order o1 ON o1.supplier_settle_status = 2 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.supplier_settle_status != 2 AND o2.id = o.id
WHERE o.bill_time = ?bill_time
GROUP BY o.bill_time ,o.supplier_id,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = t.supplier_id AND osb.type = 1
) t1
INNER JOIN t_customer c on c.parent_customer_id !='0' AND c.id = t1.customer_id AND c.parent_customer_id=?parent_customer_id
GROUP BY t1.bill_time,t1.supplier_id,c.parent_customer_id
) t2
LEFT JOIN t_order_settle_bill osb1 ON osb1.settle_bill_time= t2.bill_time AND  osb1.supplier_id = t2.supplier_id AND osb1.parent_customer_id=t2.parent_customer_id AND osb1.type = 2
)
SELECT count(1) cnt FROM tmp t
INNER JOIN t_supplier s ON s.id = t.supplier_id
WHERE 1=1
{% if supplier_id != "" %}
   and t.supplier_id = ?supplier_id
{% endif %}

[[query.supplier.cus.settle.by.manage.list]]
with tmp as(
 SELECT
  t2.bill_time,
  t2.supplier_id,
  t2.parent_customer_id,
  t2.check_price,
  customer_quota,
  COALESCE(osb1.admin_abate_quota,0) as admin_quota,
  osb1.id settle_id,
  check_price - COALESCE(osb1.admin_abate_quota,0) * 100 as supplier_bill_price,
  CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  ready_pay_price,
  CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  finish_price,
  CASE ready_pay_price WHEN 0 THEN 1 ELSE 2 END  status
FROM (
  SELECT
  t1.bill_time,
  t1.supplier_id,
  c.parent_customer_id,
  sum(check_price) check_price,
  sum(customer_quota) customer_quota,
  sum(ready_pay_price) ready_pay_price,
  sum(finish_price) finish_price
FROM (
  SELECT
  t.*,
  COALESCE(osb.customer_abate_quota,0) customer_quota
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  o.supplier_id,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.buy_from_supplier_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.buy_from_supplier_price,0)) finish_price
FROM t_order o
LEFT JOIN t_order o1 ON o1.supplier_settle_status = 2 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.supplier_settle_status != 2 AND o2.id = o.id
WHERE o.bill_time = ?bill_time
GROUP BY o.bill_time ,o.supplier_id,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = t.supplier_id AND osb.type = 1
) t1
INNER JOIN t_customer c on c.parent_customer_id !='0' AND c.id = t1.customer_id AND c.parent_customer_id=?parent_customer_id
GROUP BY t1.bill_time,t1.supplier_id,c.parent_customer_id
) t2
LEFT JOIN t_order_settle_bill osb1 ON osb1.settle_bill_time= t2.bill_time AND  osb1.supplier_id = t2.supplier_id AND osb1.parent_customer_id=t2.parent_customer_id AND osb1.type = 2
)
SELECT t.*,s.name supplier_name,c.name parent_customer_name FROM tmp t
INNER JOIN t_supplier s ON s.id = t.supplier_id
INNER JOIN t_customer c ON c.id = t.parent_customer_id
WHERE 1=1
{% if supplier_id != "" %}
   and t.supplier_id = ?supplier_id
{% endif %}
order by t.bill_time desc,t.supplier_id limit ?page_size offset (?page_num - 1) * ?page_size

[[query.supplier.cus.settle.detail.by.manage.cnt]]
with tmp as(
 SELECT
   osb.id settle_id,
   t.bill_time,
    t.supplier_id,
    t.customer_id,
    customer_settle_price - COALESCE(osb.customer_abate_quota,0) * 100 as customer_settle_price,
    COALESCE(osb.customer_abate_quota,0) customer_quota,
    CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb.customer_abate_quota,0) * 100 END  ready_pay_price,
    CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb.customer_abate_quota,0) * 100 END  finish_price,
    status/cnt  settle_status
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  sum(o.receive_amount * o.sale_to_customer_price) customer_settle_price,
  o.supplier_id,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.sale_to_customer_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.sale_to_customer_price,0)) finish_price,
   count(o.customer_id) cnt,
   sum(o.supplier_settle_status) status
FROM t_order o
LEFT JOIN t_order o1 ON o1.customer_settle_status != 1 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.customer_settle_status = 1 AND o2.id = o.id
WHERE o.bill_time = ?bill_time AND o.supplier_id=?supplier_id
GROUP BY o.bill_time ,o.supplier_id,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = t.supplier_id AND osb.type = 1
)
SELECT
count(1) cnt
FROM tmp t
INNER JOIN t_customer c ON c.id = t.customer_id and c.parent_customer_id = ?parent_customer_id
WHERE 1=1
{% if customer_id != "" %}
   and t.customer_id = ?customer_id
{% endif %}
{% if settle_status == "1" %}
   and t.settle_status = 2
{% endif %}
{% if settle_status == "2" %}
   and t.settle_status = 3
{% endif %}
{% if settle_status == "3" %}
   and t.settle_status = 1
{% endif %}

[[query.supplier.cus.settle.detail.by.manage.list]]
with tmp as(
 SELECT
   osb.id settle_id,
   t.bill_time,
   t.check_price,
    t.supplier_id,
    t.customer_id,
    customer_settle_price - COALESCE(osb.customer_abate_quota,0) * 100 as customer_settle_price,
    COALESCE(osb.customer_abate_quota,0) customer_quota,
    CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb.customer_abate_quota,0) * 100 END  ready_pay_price,
    CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb.customer_abate_quota,0) * 100 END  finish_price,
    status/cnt  settle_status
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  sum(o.receive_amount * o.sale_to_customer_price) customer_settle_price,
  o.supplier_id,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.sale_to_customer_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.sale_to_customer_price,0)) finish_price,
   count(o.customer_id) cnt,
   sum(o.supplier_settle_status) status
FROM t_order o
LEFT JOIN t_order o1 ON o1.customer_settle_status != 1 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.customer_settle_status = 1 AND o2.id = o.id
WHERE o.bill_time = ?bill_time AND o.supplier_id=?supplier_id
GROUP BY o.bill_time ,o.supplier_id,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = t.supplier_id AND osb.type = 1
)
SELECT
 t.*,
 c.name customer_name,
 CASE t.settle_status WHEN 1 THEN '供应商已收款'
                      WHEN 2 THEN '中心未付款'
                      WHEN 3 THEN '供应商未收款'
                      ELSE  '错误' END AS settle_status_desc,
 t2.total_customer_quota
FROM tmp t
INNER JOIN t_customer c ON c.id = t.customer_id and c.parent_customer_id = ?parent_customer_id
 LEFT JOIN  (SELECT sum(t.customer_quota) total_customer_quota FROM tmp t where 1=1
   {% if customer_id != "" %}
      and t.customer_id = ?customer_id
   {% endif %}
   {% if settle_status == "1" %}
      and t.settle_status = 2
   {% endif %}
   {% if settle_status == "2" %}
      and t.settle_status = 3
   {% endif %}
   {% if settle_status == "3" %}
      and t.settle_status = 1
   {% endif %}
 ) t2 ON 1=1
WHERE 1=1
{% if customer_id != "" %}
   and t.customer_id = ?customer_id
{% endif %}
{% if settle_status == "1" %}
   and t.settle_status = 2
{% endif %}
{% if settle_status == "2" %}
   and t.settle_status = 3
{% endif %}
{% if settle_status == "3" %}
   and t.settle_status = 1
{% endif %}
order by t.customer_id limit ?page_size offset (?page_num - 1) * ?page_size

[[query.supplier.bill.month.by.supplier.cnt]]

with tmp as (
  SELECT
  osb1.id settle_id,
  t2.bill_time,
  t2.parent_customer_id,
  t2.check_price,
  customer_quota,
  COALESCE(osb1.admin_abate_quota,0) as admin_quota,
  check_price - COALESCE(osb1.admin_abate_quota,0) * 100 as supplier_bill_price,
  CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  ready_pay_price,
  CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  finish_price
FROM (
  SELECT
  t1.bill_time,
  c.parent_customer_id,
  sum(check_price) check_price,
  sum(customer_quota) customer_quota,
  sum(ready_pay_price) ready_pay_price,
  sum(finish_price) finish_price
FROM (
  SELECT
  t.*,
  COALESCE(osb.customer_abate_quota,0) customer_quota
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.buy_from_supplier_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.buy_from_supplier_price,0)) finish_price
FROM t_order o
LEFT JOIN t_order o1 ON o1.supplier_settle_status = 2 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.supplier_settle_status != 2 AND o2.id = o.id
WHERE o.supplier_id = ?supplier_id and o.bill_time NOTNULL
GROUP BY o.bill_time ,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = ?supplier_id AND osb.type = 1
) t1
INNER JOIN t_customer c on c.parent_customer_id !='0' AND c.id = t1.customer_id
GROUP BY t1.bill_time,c.parent_customer_id
) t2
LEFT JOIN t_order_settle_bill osb1 ON osb1.settle_bill_time= t2.bill_time AND  osb1.supplier_id = ?supplier_id AND osb1.parent_customer_id=t2.parent_customer_id AND osb1.type = 2
)
select count(1) cnt from tmp t
INNER JOIN t_customer c ON c.id = t.parent_customer_id
WHERE 1=1
{% if bill_time != "" %}
   and t.bill_time = ?bill_time
{% endif %}
{% if parent_customer_id!="" %}
  and  t.parent_customer_id = ?parent_customer_id
{% endif %}

[[query.supplier.bill.month.by.supplier.list]]
with tmp as (
  SELECT
  osb1.id settle_id,
  t2.bill_time,
  t2.parent_customer_id,
  t2.check_price,
  customer_quota,
  COALESCE(osb1.admin_abate_quota,0) as admin_quota,
  check_price - COALESCE(osb1.admin_abate_quota,0) * 100 as supplier_bill_price,
  CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  ready_pay_price,
  CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb1.admin_abate_quota,0) * 100 END  finish_price,
  CASE t2.status WHEN 3 THEN 2 ELSE 1 END  status
FROM (
  SELECT
  t1.bill_time,
  avg(t1.status) status,
  c.parent_customer_id,
  sum(check_price) check_price,
  sum(customer_quota) customer_quota,
  sum(ready_pay_price) ready_pay_price,
  sum(finish_price) finish_price
FROM (
  SELECT
  t.*,
  COALESCE(osb.customer_abate_quota,0) customer_quota
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.buy_from_supplier_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.buy_from_supplier_price,0)) finish_price,
   avg(o.supplier_settle_status) status
FROM t_order o
LEFT JOIN t_order o1 ON o1.supplier_settle_status != 1 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.supplier_settle_status = 1 AND o2.id = o.id
WHERE o.supplier_id = ?supplier_id and o.bill_time NOTNULL
GROUP BY o.bill_time ,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = ?supplier_id AND osb.type = 1
) t1
INNER JOIN t_customer c on c.parent_customer_id !='0' AND c.id = t1.customer_id
GROUP BY t1.bill_time,c.parent_customer_id
) t2
LEFT JOIN t_order_settle_bill osb1 ON osb1.settle_bill_time= t2.bill_time AND  osb1.supplier_id = ?supplier_id AND osb1.parent_customer_id=t2.parent_customer_id AND osb1.type = 2
)
select t.*,c.name parent_customer_name,
  ROW_NUMBER() over( order by t.bill_time desc,t.parent_customer_id) row_num
 from tmp t
INNER JOIN t_customer c ON c.id = t.parent_customer_id
WHERE 1=1
{% if bill_time != "" %}
   and t.bill_time = ?bill_time
{% endif %}
{% if parent_customer_id!="" %}
  and  t.parent_customer_id = ?parent_customer_id
{% endif %}
order by t.bill_time desc,t.parent_customer_id limit ?page_size offset (?page_num - 1) * ?page_size

[[query.supplier.cus.settle.detail.by.supplier.cnt]]
with tmp as(
 SELECT
   osb.id settle_id,
   t.bill_time,
  t.check_price,
    t.customer_id,
    customer_settle_price - COALESCE(osb.customer_abate_quota,0) * 100 as customer_settle_price,
    COALESCE(osb.customer_abate_quota,0) customer_quota,
    CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb.customer_abate_quota,0) * 100 END  ready_pay_price,
    CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb.customer_abate_quota,0) * 100 END  finish_price,
    status/cnt  settle_status
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  sum(o.receive_amount * o.sale_to_customer_price) customer_settle_price,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.sale_to_customer_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.sale_to_customer_price,0)) finish_price,
   count(o.customer_id) cnt,
   sum(o.supplier_settle_status) status
FROM t_order o
LEFT JOIN t_order o1 ON o1.customer_settle_status != 1 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.customer_settle_status = 1 AND o2.id = o.id
WHERE o.bill_time = ?bill_time AND o.supplier_id=?supplier_id
GROUP BY o.bill_time ,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = ?supplier_id AND osb.type = 1
)
SELECT
count(1) cnt
FROM tmp t
INNER JOIN t_customer c ON c.id = t.customer_id and c.parent_customer_id = ?parent_customer_id
WHERE 1=1
{% if customer_id != "" %}
   and t.customer_id = ?customer_id
{% endif %}
{% if settle_status == "1" %}
   and t.settle_status = 2
{% endif %}
{% if settle_status == "2" %}
   and t.settle_status = 3
{% endif %}
{% if settle_status == "3" %}
   and t.settle_status = 1
{% endif %}

[[query.supplier.cus.settle.detail.by.supplier.list]]
with tmp as(
 SELECT
   osb.id settle_id,
   t.bill_time,
  t.check_price,
    t.customer_id,
    customer_settle_price - COALESCE(osb.customer_abate_quota,0) * 100 as customer_settle_price,
    COALESCE(osb.customer_abate_quota,0) customer_quota,
    CASE ready_pay_price WHEN 0 THEN 0 ELSE ready_pay_price - COALESCE(osb.customer_abate_quota,0) * 100 END  ready_pay_price,
    CASE finish_price WHEN 0 THEN 0 ELSE finish_price - COALESCE(osb.customer_abate_quota,0) * 100 END  finish_price,
    status/cnt  settle_status
FROM (
  SELECT
  o.bill_time,
  sum(o.receive_amount * o.buy_from_supplier_price) check_price,
  sum(o.receive_amount * o.sale_to_customer_price) customer_settle_price,
  o.customer_id,
   sum(o.receive_amount * COALESCE(o1.sale_to_customer_price,0)) ready_pay_price,
   sum(o.receive_amount * COALESCE(o2.sale_to_customer_price,0)) finish_price,
   count(o.customer_id) cnt,
   sum(o.supplier_settle_status) status
FROM t_order o
LEFT JOIN t_order o1 ON o1.customer_settle_status != 1 AND o1.id = o.id
LEFT JOIN t_order o2 ON o2.customer_settle_status = 1 AND o2.id = o.id
WHERE o.bill_time = ?bill_time AND o.supplier_id=?supplier_id
GROUP BY o.bill_time ,o.customer_id
) t
LEFT JOIN t_order_settle_bill osb ON osb.settle_bill_time= t.bill_time AND t.customer_id= osb.customer_id AND osb.supplier_id = ?supplier_id AND osb.type = 1
)
SELECT
 t.*,
 c.name customer_name,
 CASE t.settle_status WHEN 1 THEN '供应商已收款'
                      WHEN 2 THEN '中心未付款'
                      WHEN 3 THEN '供应商未收款'
                      ELSE  '错误' END AS settle_status_desc,
   t2.total_customer_quota
FROM tmp t
INNER JOIN t_customer c ON c.id = t.customer_id and c.parent_customer_id = ?parent_customer_id
LEFT JOIN  (SELECT sum(t.customer_quota) total_customer_quota FROM tmp t where 1=1
{% if customer_id != "" %}
   and t.customer_id = ?customer_id
{% endif %}
{% if settle_status == "1" %}
   and t.settle_status = 2
{% endif %}
{% if settle_status == "2" %}
   and t.settle_status = 3
{% endif %}
{% if settle_status == "3" %}
   and t.settle_status = 1
{% endif %}
) t2 ON 1=1
WHERE 1=1
{% if customer_id != "" %}
   and t.customer_id = ?customer_id
{% endif %}
{% if settle_status == "1" %}
   and t.settle_status = 2
{% endif %}
{% if settle_status == "2" %}
   and t.settle_status = 3
{% endif %}
{% if settle_status == "3" %}
   and t.settle_status = 1
{% endif %}
order by t.customer_id limit ?page_size offset (?page_num - 1) * ?page_size

[[supplier.financial.bill.time.by.manage.list]]
select bill_time
from t_order where bill_time is not null
{% if type == 2 %}
   and supplier_id = ?supplier_id
{% endif %}
group by bill_time ORDER BY bill_time DESC

[[select.supplier.all.by.manage.list]]
select s.id,s.name from t_supplier s where s.status = 1

[[abate.quota.all.list]]
SELECT
 CASE osb.type WHEN 1 THEN osb.customer_abate_quota ELSE osb.admin_abate_quota END as abate_quota,
  CASE osb.type WHEN 1 THEN osb.customer_abate_reason ELSE osb.admin_abate_reason  END as abate_reason,
  osb.update_time abate_time,
  acc.name account_name
FROM t_order_settle_bill osb
INNER JOIN t_account acc ON acc.id=osb.create_account
WHERE osb.id = ?order_settle_id

[[supplier.check.bills.receipted.by.cust.cnt]]
select count(1) from (
   select ocb.supplier_check_bill_time, c1.id customer_id,c1.name customer_name
   from t_order_check_bill ocb
     left join t_order o on ocb.order_id = o.id
     left join t_customer c1 on c1.id = o.customer_id
     left join t_customer c2 on c2.id = c1.parent_customer_id
   where 1 = 1 and ocb.supplier_check_bill_time is not null
   and o.supplier_id = ?supplier_id
      and ocb.supplier_check_bill_time = ?bill_time
      and c2.id = ?parent_customer_id
 {% if keyword!="" %}
   and c1.name ilike '%'|| ?keyword ||'%'
 {% endif %}
   group by ocb.supplier_check_bill_time , c1.id
) z

[[supplier.check.bills.receipted.by.cust.list]]
with tem as (
    select ocb.supplier_check_bill_time, c1.id customer_id,c1.name customer_name,c2.name parent_customer_name,c2.id parent_customer_id from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
      left join t_customer c2 on c2.id = c1.parent_customer_id
    where 1 = 1 and ocb.supplier_check_bill_time is not null
    and o.supplier_id = ?supplier_id
    and ocb.supplier_check_bill_time = ?bill_time
    and c2.id = ?parent_customer_id
     {% if keyword!="" %}
       and c1.name ilike '%'|| ?keyword ||'%'
     {% endif %}
    group by ocb.supplier_check_bill_time , c1.id,c2.id
)
select
    ROW_NUMBER () OVER (ORDER BY t.supplier_check_bill_time desc) AS row_num,
    t.customer_id,
    t.customer_name,
    t.parent_customer_id,
    t.parent_customer_name,
    t.supplier_check_bill_time,
    COALESCE(o1.supplier_check_count,0) supplier_check_count,
    COALESCE(o1.supplier_check_amount,0) supplier_check_amount,
    COALESCE(o2.customer_checked_count,0) customer_checked_count,
    COALESCE(o2.customer_checked_amount,0) customer_checked_amount,
    COALESCE(o3.both_checked_count,0) both_checked_count,
    COALESCE(o3.both_checked_amount,0) both_checked_amount,
    COALESCE(o4.customer_received_count,0) customer_received_count,
    COALESCE(o4.customer_received_amount,0) customer_received_amount,
    COALESCE(o4.supplier_shipped_amount,0) supplier_shipped_amount,
    COALESCE(o5.supplier_checked_count,0) supplier_checked_count,
    COALESCE(o5.supplier_checked_amount,0) supplier_checked_amount
from tem t
left join (
    select count(*) supplier_check_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) supplier_check_amount,ocb.supplier_check_bill_time , c1.id customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id

    where 1 = 1 and ocb.supplier_check_status != 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c1.id
) o1 on t.supplier_check_bill_time = o1.supplier_check_bill_time and t.customer_id = o1.customer_id
left join (
    select count(*) customer_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) customer_checked_amount,ocb.supplier_check_bill_time , c1.id customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id

    where 1 = 1 and ocb.customer_check_status = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c1.id
) o2 on t.supplier_check_bill_time = o2.supplier_check_bill_time and t.customer_id = o2.customer_id
left join (
    select count(*) both_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) both_checked_amount,ocb.supplier_check_bill_time , c1.id customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id

    where 1 = 1 and ocb.supplier_check_status = 1 and ocb.customer_check_status = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c1.id
) o3 on t.supplier_check_bill_time = o3.supplier_check_bill_time and t.customer_id = o3.customer_id
left join (
    select count(*) customer_received_count, sum(o.settle_amount * o.buy_from_supplier_price) supplier_shipped_amount, sum(ocb.supplier_amount * o.buy_from_supplier_price) customer_received_amount,ocb.supplier_check_bill_time , c1.id customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
    where 1 = 1 and ocb.order_status in (9,12) and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c1.id
) o4 on t.supplier_check_bill_time = o4.supplier_check_bill_time and t.customer_id = o4.customer_id
left join (
    select count(*) supplier_checked_count, sum(ocb.supplier_amount * o.buy_from_supplier_price) supplier_checked_amount,ocb.supplier_check_bill_time , c1.id customer_id
    from t_order_check_bill ocb
      left join t_order o on ocb.order_id = o.id
      left join t_customer c1 on c1.id = o.customer_id
    where 1 = 1 and ocb.order_status in (9,12) and ocb.supplier_check_status = 1 and o.supplier_id = ?supplier_id
    group by ocb.supplier_check_bill_time , c1.id
) o5 on t.supplier_check_bill_time = o5.supplier_check_bill_time and t.customer_id = o5.customer_id
order by t.supplier_check_bill_time desc
limit ?page_size offset (?page_num - 1) * ?page_size

[[get.supplier.summary.by.cus]]
WITH tmp as(
  SELECT sum(sale_to_customer_price*o.receive_amount) total,cate_lv2_id,supplier_id FROM t_order o
INNER JOIN t_product_category pc ON pc.id = o.cate_lv2_id
INNER JOIN t_customer tc ON tc.id = o.customer_id
WHERE pc.parent_id = ?cate_lv1_id
AND order_status in (9,12)
{% if keyword!="" %}
   and (tc.name ilike '%'|| ?keyword ||'%' or CnFirstChar(tc.name) ilike '%'|| ?keyword ||'%')
{% endif %}
   {% if !start_finish_time.IsZero() %}
   and o.finish_time>=to_date(?start_finish_time,'YYYY-MM-DD')
   {% endif%}
   {% if !end_finish_time.IsZero() %}
   and o.finish_time<to_date(?end_finish_time,'YYYY-MM-DD')+1
   {% endif%}
GROUP BY o.cate_lv2_id,supplier_id
)
select array_agg(cate_lv2_id)as array_ids,array_agg(total) as array_prices,s.id supplier_id,sum(total) total_price,s.name supplier_name
  FROM tmp t
  INNER JOIN t_supplier s ON s.id=t.supplier_id
  GROUP BY s.id

[[update.check.for.sup.first]]
update t_order_check_bill set supplier_check_status = 1,supplier_check_time = now() ,update_time = now() where
				order_id IN (SELECT order_id FROM t_order_check_bill ocb
					INNER JOIN t_order o ON o.id = ocb.order_id AND o.supplier_id = ?supplier_id and o.customer_id = ?customer_id
					INNER JOIN t_goods g ON g.id = o.goods_id and g.status = 1
					WHERE ocb.supplier_check_bill_time = ?bill_time AND ocb.supplier_check_status != 1 and ocb.order_status in(9,12)
					 {% if cate_lv1_id!="" %}
                             and g.cate_lv1_id = ?cate_lv1_id
                          {% endif%}
                          {% if cate_lv2_id!="" %}
                             and g.cate_lv2_id = ?cate_lv2_id
                          {% endif%}
                          {% if prd_id!="" %}
                             and g.prd_id = ?prd_id
                          {% endif%}
                          {% if !begin_order_time.IsZero() %}
                             and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
                          {% endif%}
                          {% if !end_order_time.IsZero() %}
                             and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
                          {% endif%}
                          {% if !begin_ship_time.IsZero() %}
                             and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
                          {% endif%}
                          {% if !end_ship_time.IsZero() %}
                             and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
                          {% endif%}
                          {% if !begin_order_sign_time.IsZero() %}
                             and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
                          {% endif%}
                          {% if !end_order_sign_time.IsZero() %}
                             and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
                          {% endif%}
					)
				and (customer_check_bill_time = ?bill_time or supplier_check_bill_time = ?bill_time) and order_status in (9,12)

[[update.check.for.sup.second]]
update t_order_check_bill set supplier_check_status = 1,supplier_check_time = now() ,update_time = now() where
				order_id IN (SELECT order_id FROM t_order_check_bill ocb
					INNER JOIN t_order o ON o.id = ocb.order_id AND o.supplier_id = ?supplier_id and o.customer_id = ?customer_id
						INNER JOIN t_goods g ON g.id = o.goods_id and g.status = 1
					WHERE ocb.supplier_check_bill_time = ?bill_time AND ocb.supplier_check_status != 1 and ocb.customer_check_status = 1 and ocb.order_status in(9,12)
					{% if cate_lv1_id!="" %}
                                                 and g.cate_lv1_id = ?cate_lv1_id
                                              {% endif%}
                                              {% if cate_lv2_id!="" %}
                                                 and g.cate_lv2_id = ?cate_lv2_id
                                              {% endif%}
                                              {% if prd_id!="" %}
                                                 and g.prd_id = ?prd_id
                                              {% endif%}
                                              {% if !begin_order_time.IsZero() %}
                                                 and o.order_time >= to_date(?begin_order_time,'YYYY-MM-DD')
                                              {% endif%}
                                              {% if !end_order_time.IsZero() %}
                                                 and o.order_time<to_date(?end_order_time,'YYYY-MM-DD')+1
                                              {% endif%}
                                              {% if !begin_ship_time.IsZero() %}
                                                 and o.ship_time>=to_date(?begin_ship_time,'YYYY-MM-DD')
                                              {% endif%}
                                              {% if !end_ship_time.IsZero() %}
                                                 and o.ship_time<to_date(?end_ship_time,'YYYY-MM-DD')+1
                                              {% endif%}
                                              {% if !begin_order_sign_time.IsZero() %}
                                                 and o.order_sign_time>=to_date(?begin_order_sign_time,'YYYY-MM-DD')
                                              {% endif%}
                                              {% if !end_order_sign_time.IsZero() %}
                                                 and o.order_sign_time<to_date(?end_order_sign_time,'YYYY-MM-DD')+1
                                              {% endif%}
					)
				and (customer_check_bill_time = ?bill_time or supplier_check_bill_time = ?bill_time) and order_status in (9,12) and customer_check_status = 1